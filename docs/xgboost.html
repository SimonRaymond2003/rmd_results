<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>XGBoost Prediction Model</title>

<script src="site_libs/header-attrs-2.22/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">4th Downs in the NFL</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="heckman.html">Heckman Selection</a>
</li>
<li>
  <a href="xgboost.html">XGBoost Prediction</a>
</li>
<li>
  <a href="attendance_binary.html">Attendance Impact Binary</a>
</li>
<li>
  <a href="thirddown.html">Third Down Analysis</a>
</li>
<li>
  <a href="attempt_ols.html">Attempts OLS</a>
</li>
<li>
  <a href="robustness_checks.html">Robustness Checks</a>
</li>
<li>
  <a href="Writing.html">Writing</a>
</li>
<li>
  <a href="kicker_exogenous.html">Proof of Exogeniety</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">XGBoost Prediction Model</h1>

</div>


<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(data.table)   </span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>outcome_data <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;predict_outcome.csv.gz&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># Filter out year*_team columns</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>year_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">&quot;^year[0-9]+_team&quot;</span>, <span class="fu">names</span>(outcome_data), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>outcome_data[, (year_cols) <span class="sc">:=</span> <span class="cn">NULL</span>]</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Function to check column variance and other potential issues</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>check_columns <span class="ot">&lt;-</span> <span class="cf">function</span>(dt) {</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="co"># Create a list to store results</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  col_issues <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="at">zero_var =</span> <span class="fu">character</span>(),</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="at">all_na =</span> <span class="fu">character</span>(),</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="at">perfect_cor =</span> <span class="fu">character</span>(),</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    <span class="at">character_cols =</span> <span class="fu">character</span>()</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  )</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  </span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  <span class="co"># First, identify character columns (except my_id)</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  <span class="cf">for</span>(col <span class="cf">in</span> <span class="fu">names</span>(dt)) {</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.character</span>(dt[[col]]) <span class="sc">&amp;&amp;</span> col <span class="sc">!=</span> <span class="st">&quot;my_id&quot;</span>) {</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>      col_issues<span class="sc">$</span>character_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(col_issues<span class="sc">$</span>character_cols, col)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    }</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  }</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  </span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>  <span class="co"># Get numeric columns only</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>  numeric_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(dt)[<span class="fu">sapply</span>(dt, is.numeric)]</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>  numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(numeric_cols, <span class="st">&quot;conversion&quot;</span>)  <span class="co"># exclude target variable</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  </span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>  <span class="co"># Check each numeric column</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="cf">for</span>(col <span class="cf">in</span> numeric_cols) {</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>    <span class="co"># Get column data without NAs</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>    col_data <span class="ot">&lt;-</span> dt[[col]][<span class="sc">!</span><span class="fu">is.na</span>(dt[[col]])]</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>    </span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>    <span class="co"># Check for zero variance</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(col_data)) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>      col_issues<span class="sc">$</span>zero_var <span class="ot">&lt;-</span> <span class="fu">c</span>(col_issues<span class="sc">$</span>zero_var, col)</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>    }</span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    </span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    <span class="co"># Check for all NA</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">is.na</span>(dt[[col]]))) {</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>      col_issues<span class="sc">$</span>all_na <span class="ot">&lt;-</span> <span class="fu">c</span>(col_issues<span class="sc">$</span>all_na, col)</span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>    }</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>  }</span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>  </span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>  <span class="co"># Check correlations for remaining numeric columns</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>  remaining_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(numeric_cols, </span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>                          <span class="fu">unique</span>(<span class="fu">c</span>(col_issues<span class="sc">$</span>zero_var, col_issues<span class="sc">$</span>all_na)))</span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>  </span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(remaining_cols) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>    <span class="co"># Create correlation matrix</span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>    cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(dt[, ..remaining_cols], <span class="at">use =</span> <span class="st">&quot;pairwise.complete.obs&quot;</span>)</span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a>    </span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a>    <span class="co"># Find highly correlated pairs</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(remaining_cols)<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(remaining_cols)) {</span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(cor_matrix[i,j]) <span class="sc">&amp;&amp;</span> <span class="fu">abs</span>(cor_matrix[i,j]) <span class="sc">&gt;</span> <span class="fl">0.9999</span>) {</span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>          col_issues<span class="sc">$</span>perfect_cor <span class="ot">&lt;-</span> <span class="fu">c</span>(col_issues<span class="sc">$</span>perfect_cor, remaining_cols[j])</span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a>        }</span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a>      }</span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a>    }</span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a>  }</span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a>  </span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a>  <span class="fu">return</span>(col_issues)</span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a>}</span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a><span class="co"># Find problematic columns</span></span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a>issues <span class="ot">&lt;-</span> <span class="fu">check_columns</span>(outcome_data)</span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a><span class="co"># Print summary of issues found</span></span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Found the following issues:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Found the following issues:</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(issues<span class="sc">$</span>character_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Character columns (excluding my_id):&quot;</span>, <span class="fu">paste</span>(issues<span class="sc">$</span>character_cols, <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>))</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(issues<span class="sc">$</span>zero_var) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Zero variance columns:&quot;</span>, <span class="fu">paste</span>(issues<span class="sc">$</span>zero_var, <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>))</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Zero variance columns: offense_player_3_present, offense_player_7_present, offense_player_13_present, defense_player_7_present, defense_player_8_present</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(issues<span class="sc">$</span>all_na) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">All NA columns:&quot;</span>, <span class="fu">paste</span>(issues<span class="sc">$</span>all_na, <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>))</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>}</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(issues<span class="sc">$</span>perfect_cor) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Perfectly correlated columns:&quot;</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(issues<span class="sc">$</span>perfect_cor), <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>))</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Perfectly correlated columns: offense_player_18_present, offense_player_19_present, offense_player_21_present</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Combine all problematic columns</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>problem_cols <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(issues<span class="sc">$</span>zero_var, issues<span class="sc">$</span>all_na, </span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                        issues<span class="sc">$</span>perfect_cor, issues<span class="sc">$</span>character_cols))</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co"># Remove problematic columns</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(problem_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  outcome_data[, (problem_cols) <span class="sc">:=</span> <span class="cn">NULL</span>]</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>}</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co"># Print summary of remaining columns</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">Removed&quot;</span>, <span class="fu">length</span>(problem_cols), <span class="st">&quot;problematic columns&quot;</span>)</span></code></pre></div>
<pre><code>## 
## 
## Removed 8 problematic columns</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Remaining columns:&quot;</span>, <span class="fu">ncol</span>(outcome_data))</span></code></pre></div>
<pre><code>## 
## Remaining columns: 248</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Load library and prepare data</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#library(randomForest)</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#rf_data &lt;- copy(outcome_data)[, my_id := NULL]</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">#rf_data[, conversion := as.factor(conversion)]</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co"># Run RF and get OOB AUC</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">#rf_model &lt;- randomForest(conversion ~ ., data = rf_data, ntree = 100, importance = TRUE)</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co">#pred_oob &lt;- predict(rf_model, type = &quot;prob&quot;)[,2]</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">#cat(&quot;\nOOB AUC:&quot;, as.numeric(performance(prediction(pred_oob, as.numeric(as.character(rf_data$conversion))), &quot;auc&quot;)@y.values))</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="co"># Filter variables based on positive MDA</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co">#mda_scores &lt;- importance(rf_model)[, &quot;MeanDecreaseAccuracy&quot;]</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#keep_vars &lt;- unique(c(names(mda_scores[mda_scores &gt; 0]), &quot;my_id&quot;, &quot;conversion&quot;))</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co">#outcome_data &lt;- outcome_data[, .SD, .SDcols = keep_vars]</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co">#cat(&quot;\nVariables kept:&quot;, length(keep_vars), &quot;out of&quot;, ncol(rf_data) + 1)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code></pre></div>
<pre><code>## randomForest 4.7-1.1</code></pre>
<pre><code>## Type rfNews() to see new features/changes/bug fixes.</code></pre>
<pre><code>## 
## Attaching package: &#39;randomForest&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:ggplot2&#39;:
## 
##     margin</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">library</span>(ROCR)  <span class="co"># Added this library</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co"># Initialize variables for RF loop</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>rf_data <span class="ot">&lt;-</span> <span class="fu">copy</span>(outcome_data)[, my_id <span class="sc">:=</span> <span class="cn">NULL</span>]</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>rf_data[, conversion <span class="sc">:=</span> <span class="fu">as.factor</span>(conversion)]</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>previous_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co"># Iterative RF process for variable selection</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="cf">while</span>(<span class="cn">TRUE</span>) {</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    <span class="co"># Run RF</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>    rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(conversion <span class="sc">~</span> ., <span class="at">data =</span> rf_data, <span class="at">ntree =</span> <span class="dv">100</span>, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>    pred_oob <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">2</span>]</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>    </span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>    <span class="co"># Calculate OOB AUC using ROCR</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(pred_oob, <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(rf_data<span class="sc">$</span>conversion)))</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>    current_auc <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)<span class="sc">@</span>y.values)</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>    </span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Current AUC:&quot;</span>, <span class="fu">round</span>(current_auc, <span class="dv">4</span>), <span class="st">&quot;with&quot;</span>, <span class="fu">ncol</span>(rf_data)<span class="sc">-</span><span class="dv">1</span>, <span class="st">&quot;variables&quot;</span>)</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>    </span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>    <span class="co"># Check if AUC dropped</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(previous_data) <span class="sc">&amp;&amp;</span> current_auc <span class="sc">&lt;</span> best_auc) {</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">AUC dropped, reverting to previous state&quot;</span>)</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>        outcome_data <span class="ot">&lt;-</span> previous_data</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a>    }</span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>    </span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>    <span class="co"># Update best and prepare for next iteration</span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a>    <span class="cf">if</span>(current_auc <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> current_auc</span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a>        previous_data <span class="ot">&lt;-</span> <span class="fu">copy</span>(outcome_data)</span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a>    }</span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>    </span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>    <span class="co"># Filter variables based on positive MDA</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a>    mda_scores <span class="ot">&lt;-</span> <span class="fu">importance</span>(rf_model)[, <span class="st">&quot;MeanDecreaseAccuracy&quot;</span>]</span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a>    keep_vars <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">names</span>(mda_scores[mda_scores <span class="sc">&gt;</span> <span class="dv">0</span>]), <span class="st">&quot;my_id&quot;</span>, <span class="st">&quot;conversion&quot;</span>))</span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a>    </span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a>    <span class="co"># Update data for next iteration</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a>    outcome_data <span class="ot">&lt;-</span> outcome_data[, .SD, .SDcols <span class="ot">=</span> keep_vars]</span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a>    rf_data <span class="ot">&lt;-</span> <span class="fu">copy</span>(outcome_data)[, my_id <span class="sc">:=</span> <span class="cn">NULL</span>]</span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a>    rf_data[, conversion <span class="sc">:=</span> <span class="fu">as.factor</span>(conversion)]</span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 
## Current AUC: 0.6141 with 246 variables
## Current AUC: 0.6247 with 133 variables
## Current AUC: 0.6366 with 84 variables
## Current AUC: 0.6432 with 62 variables
## Current AUC: 0.6463 with 46 variables
## Current AUC: 0.6417 with 38 variables
## AUC dropped, reverting to previous state</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">#kill my id</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>outcome_data<span class="sc">$</span>my_id <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Run 100 tests with linear model</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Running 100 test iterations with linear model...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Running 100 test iterations with linear model...</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>test_aucs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>test_j_stats <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>confusion_matrices <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>performance_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>all_thresholds <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co"># Convert data for linear model</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">copy</span>(outcome_data)</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>model_data[, conversion <span class="sc">:=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(conversion))]</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="co"># Run 100 tests with linear model</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>test_aucs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>test_j_stats <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>confusion_matrices <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>performance_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>all_thresholds <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="co"># Convert data for linear model</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">copy</span>(outcome_data)</span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>model_data[, conversion <span class="sc">:=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(conversion))]</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>  <span class="co"># Create test split</span></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(model_data), <span class="at">size =</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(model_data)))  <span class="co"># Changed sampling approach</span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> model_data[idx, ]</span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> model_data[<span class="sc">-</span>idx, ]</span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>  </span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>  <span class="co"># Train model</span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>  mdl <span class="ot">&lt;-</span> <span class="fu">lm</span>(conversion <span class="sc">~</span> ., <span class="at">data =</span> train_data)</span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>  </span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>  <span class="co"># Get predictions and handle potential issues</span></span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl, test_data)</span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a>  </span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a>  <span class="co"># Clean predictions</span></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a>  p[<span class="fu">is.na</span>(p)] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Handle NAs</span></span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>  p[<span class="fu">is.infinite</span>(p)] <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># Handle Inf</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a>  p[p <span class="sc">&gt;</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># Bound predictions</span></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a>  p[p <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a>  </span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a>  <span class="co"># Convert predictions and actual values to numeric vectors</span></span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>  pred_values <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(p)</span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a>  actual_values <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(test_data<span class="sc">$</span>conversion)</span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a>  </span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a>  <span class="co"># Check for any remaining issues</span></span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(pred_values)) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.infinite</span>(pred_values))) {</span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Warning: Invalid predictions in iteration&quot;</span>, i, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a>  }</span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a>  </span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a>  <span class="co"># Create ROCR prediction object with error handling</span></span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(pred_values, actual_values)</span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a>    </span>
<span id="cb23-54"><a href="#cb23-54" tabindex="-1"></a>    <span class="co"># Calculate AUC</span></span>
<span id="cb23-55"><a href="#cb23-55" tabindex="-1"></a>    perf_auc <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)</span>
<span id="cb23-56"><a href="#cb23-56" tabindex="-1"></a>    test_aucs[i] <span class="ot">&lt;-</span> perf_auc<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb23-57"><a href="#cb23-57" tabindex="-1"></a>    </span>
<span id="cb23-58"><a href="#cb23-58" tabindex="-1"></a>    <span class="co"># Calculate ROC curve</span></span>
<span id="cb23-59"><a href="#cb23-59" tabindex="-1"></a>    perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;tpr&quot;</span>, <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb23-60"><a href="#cb23-60" tabindex="-1"></a>    performance_list[[i]] <span class="ot">&lt;-</span> perf</span>
<span id="cb23-61"><a href="#cb23-61" tabindex="-1"></a>    </span>
<span id="cb23-62"><a href="#cb23-62" tabindex="-1"></a>    <span class="co"># Find optimal threshold using Youden&#39;s J statistic</span></span>
<span id="cb23-63"><a href="#cb23-63" tabindex="-1"></a>    tpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb23-64"><a href="#cb23-64" tabindex="-1"></a>    fpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>x.values)</span>
<span id="cb23-65"><a href="#cb23-65" tabindex="-1"></a>    j_stats <span class="ot">&lt;-</span> tpr <span class="sc">-</span> fpr</span>
<span id="cb23-66"><a href="#cb23-66" tabindex="-1"></a>    best_j_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(j_stats)</span>
<span id="cb23-67"><a href="#cb23-67" tabindex="-1"></a>    optimal_threshold <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>alpha.values)[best_j_idx]</span>
<span id="cb23-68"><a href="#cb23-68" tabindex="-1"></a>    all_thresholds[i] <span class="ot">&lt;-</span> optimal_threshold</span>
<span id="cb23-69"><a href="#cb23-69" tabindex="-1"></a>    test_j_stats[i] <span class="ot">&lt;-</span> j_stats[best_j_idx]</span>
<span id="cb23-70"><a href="#cb23-70" tabindex="-1"></a>    </span>
<span id="cb23-71"><a href="#cb23-71" tabindex="-1"></a>    <span class="co"># Create confusion matrix</span></span>
<span id="cb23-72"><a href="#cb23-72" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pred_values <span class="sc">&gt;=</span> optimal_threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb23-73"><a href="#cb23-73" tabindex="-1"></a>    cm <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">factor</span>(actual_values, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)), </span>
<span id="cb23-74"><a href="#cb23-74" tabindex="-1"></a>               <span class="fu">factor</span>(pred_class, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb23-75"><a href="#cb23-75" tabindex="-1"></a>    <span class="fu">colnames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Pred 1&quot;</span>, <span class="st">&quot;Pred 0&quot;</span>)</span>
<span id="cb23-76"><a href="#cb23-76" tabindex="-1"></a>    <span class="fu">rownames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;True 1&quot;</span>, <span class="st">&quot;True 0&quot;</span>)</span>
<span id="cb23-77"><a href="#cb23-77" tabindex="-1"></a>    confusion_matrices[[i]] <span class="ot">&lt;-</span> cm</span>
<span id="cb23-78"><a href="#cb23-78" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb23-79"><a href="#cb23-79" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Error in iteration&quot;</span>, i, <span class="st">&quot;:&quot;</span>, e<span class="sc">$</span>message, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb23-80"><a href="#cb23-80" tabindex="-1"></a>  })</span>
<span id="cb23-81"><a href="#cb23-81" tabindex="-1"></a>}</span>
<span id="cb23-82"><a href="#cb23-82" tabindex="-1"></a></span>
<span id="cb23-83"><a href="#cb23-83" tabindex="-1"></a><span class="co"># Calculate average confusion matrix</span></span>
<span id="cb23-84"><a href="#cb23-84" tabindex="-1"></a>avg_cm <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, confusion_matrices) <span class="sc">/</span> <span class="fu">length</span>(confusion_matrices)</span>
<span id="cb23-85"><a href="#cb23-85" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" tabindex="-1"></a><span class="co"># Print final results</span></span>
<span id="cb23-87"><a href="#cb23-87" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Test Results over 100 iterations:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Test Results over 100 iterations:</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean AUC: 0.6820648</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD AUC:&quot;</span>, <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD AUC: 0.01365833</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Youden&#39;s J:&quot;</span>, <span class="fu">mean</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Youden&#39;s J: 0.2851201</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD Youden&#39;s J:&quot;</span>, <span class="fu">sd</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD Youden&#39;s J: 0.02387767</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Optimal Threshold:&quot;</span>, <span class="fu">mean</span>(all_thresholds), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Optimal Threshold: 0.5205105</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;95% CI for AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), </span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>    <span class="st">&quot;to&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 95% CI for AUC: 0.6552945 to 0.7088351</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Average Confusion Matrix:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Average Confusion Matrix:</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="fu">print</span>(avg_cm)</span></code></pre></div>
<pre><code>##         
##          Pred 1 Pred 0
##   True 1 409.46 218.55
##   True 0 212.03 365.96</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="co"># Plotting AUC distribution - removed type=&quot;o&quot; to not connect dots</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="fu">plot</span>(test_aucs, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch=</span><span class="dv">20</span>,</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;AUC Test Distribution&quot;</span>,</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Iteration&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;AUC&quot;</span>)</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;AUC Values&quot;</span>, <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;95% CI Bounds&quot;</span>),</span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>),</span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co"># Plot ROC curve with confidence intervals</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="fu">suppressWarnings</span>({</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>, </span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>       <span class="at">xlab=</span><span class="st">&quot;False Positive Rate&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;True Positive Rate&quot;</span>,</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>       <span class="at">main=</span><span class="st">&quot;ROC Curve - Linear Model&quot;</span>)</span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a>  </span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a>  <span class="co"># Calculate average ROC curve with confidence intervals</span></span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a>  fpr_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a>  tpr_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(performance_list), <span class="at">ncol =</span> <span class="fu">length</span>(fpr_grid))</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a>  </span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(performance_list)) {</span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a>    curve_i <span class="ot">&lt;-</span> performance_list[[i]]</span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a>    tpr_matrix[i,] <span class="ot">&lt;-</span> <span class="fu">approx</span>(curve_i<span class="sc">@</span>x.values[[<span class="dv">1</span>]], </span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a>                            curve_i<span class="sc">@</span>y.values[[<span class="dv">1</span>]], </span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a>                            <span class="at">xout =</span> fpr_grid)<span class="sc">$</span>y</span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a>  }</span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a>  </span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a>  mean_tpr <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(tpr_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a>  <span class="fu">lines</span>(fpr_grid, mean_tpr, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a>  </span>
<span id="cb42-21"><a href="#cb42-21" tabindex="-1"></a>  <span class="co"># Add optimal threshold point</span></span>
<span id="cb42-22"><a href="#cb42-22" tabindex="-1"></a>  opt_point_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(fpr_grid <span class="sc">-</span> <span class="fu">mean</span>(all_thresholds)))</span>
<span id="cb42-23"><a href="#cb42-23" tabindex="-1"></a>  <span class="fu">points</span>(fpr_grid[opt_point_idx], mean_tpr[opt_point_idx], </span>
<span id="cb42-24"><a href="#cb42-24" tabindex="-1"></a>         <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb42-25"><a href="#cb42-25" tabindex="-1"></a>  </span>
<span id="cb42-26"><a href="#cb42-26" tabindex="-1"></a>  <span class="co"># Add confidence interval</span></span>
<span id="cb42-27"><a href="#cb42-27" tabindex="-1"></a>  ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb42-28"><a href="#cb42-28" tabindex="-1"></a>  ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb42-29"><a href="#cb42-29" tabindex="-1"></a>  <span class="fu">lines</span>(fpr_grid, ci_lower, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb42-30"><a href="#cb42-30" tabindex="-1"></a>  <span class="fu">lines</span>(fpr_grid, ci_upper, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb42-31"><a href="#cb42-31" tabindex="-1"></a>  </span>
<span id="cb42-32"><a href="#cb42-32" tabindex="-1"></a>  <span class="co"># Add legend</span></span>
<span id="cb42-33"><a href="#cb42-33" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb42-34"><a href="#cb42-34" tabindex="-1"></a>         <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;Random&quot;</span>, <span class="st">&quot;Average ROC&quot;</span>, <span class="st">&quot;95% CI&quot;</span>, <span class="st">&quot;Optimal Threshold&quot;</span>),</span>
<span id="cb42-35"><a href="#cb42-35" tabindex="-1"></a>         <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;gray&quot;</span>, <span class="st">&quot;blue&quot;</span>), </span>
<span id="cb42-36"><a href="#cb42-36" tabindex="-1"></a>         <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="cn">NA</span>), </span>
<span id="cb42-37"><a href="#cb42-37" tabindex="-1"></a>         <span class="at">pch=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">19</span>),</span>
<span id="cb42-38"><a href="#cb42-38" tabindex="-1"></a>         <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="cn">NA</span>))</span>
<span id="cb42-39"><a href="#cb42-39" tabindex="-1"></a>})</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-6-2.png" width="672" /></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="co"># Prepare the XGBoost matrices</span></span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> . <span class="sc">-</span> <span class="dv">1</span> <span class="sc">-</span> conversion, <span class="at">data =</span> outcome_data)</span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(outcome_data<span class="sc">$</span>conversion))</span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a><span class="co"># Create parameter grid</span></span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fu">seq</span>(<span class="fl">0.001</span>, <span class="fl">0.03</span>, <span class="at">by =</span> <span class="fl">0.01</span>),</span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">2</span>),</span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a>  <span class="at">min_child_weight =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="dv">1</span>),        </span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a>  <span class="at">subsample =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a>  <span class="at">colsample_bytree =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="dv">1</span>),                </span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="at">by =</span> <span class="dv">1</span>),                  </span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a>  <span class="at">gamma =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="at">by =</span> <span class="fl">0.1</span>),               </span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">250</span>, <span class="at">by =</span> <span class="dv">50</span>)</span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a>)</span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a><span class="co"># Sample grid points</span></span>
<span id="cb43-23"><a href="#cb43-23" tabindex="-1"></a>conf_lev <span class="ot">&lt;-</span> .<span class="dv">95</span></span>
<span id="cb43-24"><a href="#cb43-24" tabindex="-1"></a>num_max <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb43-25"><a href="#cb43-25" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>conf_lev)<span class="sc">/</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>num_max<span class="sc">/</span><span class="fu">nrow</span>(grid)))</span>
<span id="cb43-26"><a href="#cb43-26" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(grid), n, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-27"><a href="#cb43-27" tabindex="-1"></a>rgrid <span class="ot">&lt;-</span> grid[ind, ]</span>
<span id="cb43-28"><a href="#cb43-28" tabindex="-1"></a></span>
<span id="cb43-29"><a href="#cb43-29" tabindex="-1"></a><span class="co"># Set up parallel processing</span></span>
<span id="cb43-30"><a href="#cb43-30" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb43-31"><a href="#cb43-31" tabindex="-1"></a></span>
<span id="cb43-32"><a href="#cb43-32" tabindex="-1"></a><span class="co"># Validation phase</span></span>
<span id="cb43-33"><a href="#cb43-33" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Phase 1: Validation Phase</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Phase 1: Validation Phase</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>n_validations <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>validation_results <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(rgrid), <span class="at">ncol =</span> n_validations)</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>validation_j_stats <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(rgrid), <span class="at">ncol =</span> n_validations)</span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(rgrid)) {</span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a> <span class="co"># cat(&quot;\nTesting parameter set&quot;, j, &quot;of&quot;, nrow(rgrid), &quot;\n&quot;)</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a>  <span class="co">#cat(&quot;eta =&quot;, rgrid[j, &quot;eta&quot;], &quot;, nrounds =&quot;, rgrid[j, &quot;nrounds&quot;], &quot;\n&quot;)</span></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>  </span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_validations) {</span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a>    <span class="co"># Create validation split</span></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sample</span>(<span class="fu">nrow</span>(xs), <span class="fu">nrow</span>(xs), T))</span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a>    train_x <span class="ot">&lt;-</span> xs[idx, ]</span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>    train_y <span class="ot">&lt;-</span> y[idx]</span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>    val_x <span class="ot">&lt;-</span> xs[<span class="sc">-</span>idx, ]</span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>    val_y <span class="ot">&lt;-</span> y[<span class="sc">-</span>idx]</span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>    </span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>    prm <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a>      <span class="at">booster =</span> <span class="st">&quot;gbtree&quot;</span>,</span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>      <span class="at">objective =</span> <span class="st">&quot;binary:logistic&quot;</span>,</span>
<span id="cb45-20"><a href="#cb45-20" tabindex="-1"></a>      <span class="at">max_depth =</span> rgrid[j, <span class="st">&quot;max_depth&quot;</span>],</span>
<span id="cb45-21"><a href="#cb45-21" tabindex="-1"></a>      <span class="at">eta =</span> rgrid[j, <span class="st">&quot;eta&quot;</span>],</span>
<span id="cb45-22"><a href="#cb45-22" tabindex="-1"></a>      <span class="at">subsample =</span> rgrid[j, <span class="st">&quot;subsample&quot;</span>],</span>
<span id="cb45-23"><a href="#cb45-23" tabindex="-1"></a>      <span class="at">colsample_bytree =</span> rgrid[j, <span class="st">&quot;colsample_bytree&quot;</span>],</span>
<span id="cb45-24"><a href="#cb45-24" tabindex="-1"></a>      <span class="at">gamma =</span> rgrid[j, <span class="st">&quot;gamma&quot;</span>],</span>
<span id="cb45-25"><a href="#cb45-25" tabindex="-1"></a>      <span class="at">min_child_weight =</span> rgrid[j, <span class="st">&quot;min_child_weight&quot;</span>],</span>
<span id="cb45-26"><a href="#cb45-26" tabindex="-1"></a>      <span class="at">alpha =</span> rgrid[j, <span class="st">&quot;alpha&quot;</span>],</span>
<span id="cb45-27"><a href="#cb45-27" tabindex="-1"></a>      <span class="at">lambda =</span> rgrid[j, <span class="st">&quot;lambda&quot;</span>],</span>
<span id="cb45-28"><a href="#cb45-28" tabindex="-1"></a>      <span class="at">nthread =</span> nc</span>
<span id="cb45-29"><a href="#cb45-29" tabindex="-1"></a>    )</span>
<span id="cb45-30"><a href="#cb45-30" tabindex="-1"></a>    </span>
<span id="cb45-31"><a href="#cb45-31" tabindex="-1"></a>    dm_train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> train_x, <span class="at">label =</span> train_y)</span>
<span id="cb45-32"><a href="#cb45-32" tabindex="-1"></a>    mdl <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb45-33"><a href="#cb45-33" tabindex="-1"></a>      <span class="at">params =</span> prm,</span>
<span id="cb45-34"><a href="#cb45-34" tabindex="-1"></a>      <span class="at">data =</span> dm_train,</span>
<span id="cb45-35"><a href="#cb45-35" tabindex="-1"></a>      <span class="at">nrounds =</span> rgrid[j, <span class="st">&quot;nrounds&quot;</span>],</span>
<span id="cb45-36"><a href="#cb45-36" tabindex="-1"></a>      <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb45-37"><a href="#cb45-37" tabindex="-1"></a>    )</span>
<span id="cb45-38"><a href="#cb45-38" tabindex="-1"></a>    </span>
<span id="cb45-39"><a href="#cb45-39" tabindex="-1"></a>    <span class="co"># Get predictions and ROC metrics</span></span>
<span id="cb45-40"><a href="#cb45-40" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl, <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> val_x))</span>
<span id="cb45-41"><a href="#cb45-41" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(p, val_y)</span>
<span id="cb45-42"><a href="#cb45-42" tabindex="-1"></a>    </span>
<span id="cb45-43"><a href="#cb45-43" tabindex="-1"></a>    <span class="co"># Calculate AUC</span></span>
<span id="cb45-44"><a href="#cb45-44" tabindex="-1"></a>    validation_results[j, i] <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb45-45"><a href="#cb45-45" tabindex="-1"></a>    </span>
<span id="cb45-46"><a href="#cb45-46" tabindex="-1"></a>    <span class="co"># Calculate Youden&#39;s J Statistic</span></span>
<span id="cb45-47"><a href="#cb45-47" tabindex="-1"></a>    roc <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;tpr&quot;</span>, <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb45-48"><a href="#cb45-48" tabindex="-1"></a>    tpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(roc<span class="sc">@</span>y.values)</span>
<span id="cb45-49"><a href="#cb45-49" tabindex="-1"></a>    fpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(roc<span class="sc">@</span>x.values)</span>
<span id="cb45-50"><a href="#cb45-50" tabindex="-1"></a>    j_stats <span class="ot">&lt;-</span> tpr <span class="sc">-</span> fpr</span>
<span id="cb45-51"><a href="#cb45-51" tabindex="-1"></a>    validation_j_stats[j, i] <span class="ot">&lt;-</span> <span class="fu">max</span>(j_stats)</span>
<span id="cb45-52"><a href="#cb45-52" tabindex="-1"></a>  }</span>
<span id="cb45-53"><a href="#cb45-53" tabindex="-1"></a>  </span>
<span id="cb45-54"><a href="#cb45-54" tabindex="-1"></a>  <span class="co">#cat(&quot;Mean AUC:&quot;, mean(validation_results[j,]), &quot;\n&quot;)</span></span>
<span id="cb45-55"><a href="#cb45-55" tabindex="-1"></a>  <span class="co">#cat(&quot;SD AUC:&quot;, sd(validation_results[j,]), &quot;\n&quot;)</span></span>
<span id="cb45-56"><a href="#cb45-56" tabindex="-1"></a>  <span class="co">#cat(&quot;Mean J statistic:&quot;, mean(validation_j_stats[j,]), &quot;\n&quot;)</span></span>
<span id="cb45-57"><a href="#cb45-57" tabindex="-1"></a>}</span>
<span id="cb45-58"><a href="#cb45-58" tabindex="-1"></a></span>
<span id="cb45-59"><a href="#cb45-59" tabindex="-1"></a><span class="co"># Select best parameters based on validation AUC</span></span>
<span id="cb45-60"><a href="#cb45-60" tabindex="-1"></a>best_params_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">rowMeans</span>(validation_results))</span>
<span id="cb45-61"><a href="#cb45-61" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> rgrid[best_params_idx,]</span>
<span id="cb45-62"><a href="#cb45-62" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Best parameters:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Best parameters:</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="fu">print</span>(best_params)</span></code></pre></div>
<pre><code>##      eta max_depth min_child_weight subsample colsample_bytree lambda alpha
## 11 0.011         5                1         1                1      1     0
##    gamma nrounds
## 11     0     250</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="co"># Run 100 tests with best parameters</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Running 100 test iterations with best parameters...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Running 100 test iterations with best parameters...</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>test_aucs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>test_j_stats <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>confusion_matrices <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a>performance_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>all_thresholds <span class="ot">&lt;-</span> <span class="fu">c</span>()                             </span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a><span class="co"># Train final model with best parameters</span></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a>best_params_list <span class="ot">&lt;-</span> <span class="fu">as.list</span>(best_params[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(best_params) <span class="sc">==</span> <span class="st">&quot;nrounds&quot;</span>)])</span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a>best_params_list<span class="sc">$</span>booster <span class="ot">&lt;-</span> <span class="st">&quot;gbtree&quot;</span></span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a>best_params_list<span class="sc">$</span>objective <span class="ot">&lt;-</span> <span class="st">&quot;binary:logistic&quot;</span></span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a>best_params_list<span class="sc">$</span>nthread <span class="ot">&lt;-</span> nc</span>
<span id="cb51-12"><a href="#cb51-12" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) {</span>
<span id="cb51-14"><a href="#cb51-14" tabindex="-1"></a>  <span class="co">#cat(&quot;\nIteration&quot;, i, &quot;of 100\n&quot;)       </span></span>
<span id="cb51-15"><a href="#cb51-15" tabindex="-1"></a>  <span class="co"># Create test split</span></span>
<span id="cb51-16"><a href="#cb51-16" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sample</span>(<span class="fu">nrow</span>(xs), <span class="fu">nrow</span>(xs), T))</span>
<span id="cb51-17"><a href="#cb51-17" tabindex="-1"></a>  train_x <span class="ot">&lt;-</span> xs[idx, ]</span>
<span id="cb51-18"><a href="#cb51-18" tabindex="-1"></a>  train_y <span class="ot">&lt;-</span> y[idx]</span>
<span id="cb51-19"><a href="#cb51-19" tabindex="-1"></a>  test_x <span class="ot">&lt;-</span> xs[<span class="sc">-</span>idx, ]</span>
<span id="cb51-20"><a href="#cb51-20" tabindex="-1"></a>  test_y <span class="ot">&lt;-</span> y[<span class="sc">-</span>idx]</span>
<span id="cb51-21"><a href="#cb51-21" tabindex="-1"></a>  </span>
<span id="cb51-22"><a href="#cb51-22" tabindex="-1"></a>  <span class="co"># Train model</span></span>
<span id="cb51-23"><a href="#cb51-23" tabindex="-1"></a>  dm_train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> train_x, <span class="at">label =</span> train_y)</span>
<span id="cb51-24"><a href="#cb51-24" tabindex="-1"></a>  mdl <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb51-25"><a href="#cb51-25" tabindex="-1"></a>    <span class="at">params =</span> best_params_list,</span>
<span id="cb51-26"><a href="#cb51-26" tabindex="-1"></a>    <span class="at">data =</span> dm_train,</span>
<span id="cb51-27"><a href="#cb51-27" tabindex="-1"></a>    <span class="at">nrounds =</span> best_params[[<span class="st">&quot;nrounds&quot;</span>]],</span>
<span id="cb51-28"><a href="#cb51-28" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb51-29"><a href="#cb51-29" tabindex="-1"></a>  )</span>
<span id="cb51-30"><a href="#cb51-30" tabindex="-1"></a>  </span>
<span id="cb51-31"><a href="#cb51-31" tabindex="-1"></a>  <span class="co"># Get predictions</span></span>
<span id="cb51-32"><a href="#cb51-32" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl, <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> test_x))</span>
<span id="cb51-33"><a href="#cb51-33" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(p, test_y)</span>
<span id="cb51-34"><a href="#cb51-34" tabindex="-1"></a>  </span>
<span id="cb51-35"><a href="#cb51-35" tabindex="-1"></a>  <span class="co"># Calculate AUC</span></span>
<span id="cb51-36"><a href="#cb51-36" tabindex="-1"></a>  test_aucs[i] <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb51-37"><a href="#cb51-37" tabindex="-1"></a>  </span>
<span id="cb51-38"><a href="#cb51-38" tabindex="-1"></a>  <span class="co"># Calculate ROC curve and store</span></span>
<span id="cb51-39"><a href="#cb51-39" tabindex="-1"></a>  perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;tpr&quot;</span>, <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb51-40"><a href="#cb51-40" tabindex="-1"></a>  performance_list[[i]] <span class="ot">&lt;-</span> perf</span>
<span id="cb51-41"><a href="#cb51-41" tabindex="-1"></a>  </span>
<span id="cb51-42"><a href="#cb51-42" tabindex="-1"></a>  <span class="co"># Find optimal threshold using Youden&#39;s J statistic</span></span>
<span id="cb51-43"><a href="#cb51-43" tabindex="-1"></a>  tpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb51-44"><a href="#cb51-44" tabindex="-1"></a>  fpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>x.values)</span>
<span id="cb51-45"><a href="#cb51-45" tabindex="-1"></a>  j_stats <span class="ot">&lt;-</span> tpr <span class="sc">-</span> fpr</span>
<span id="cb51-46"><a href="#cb51-46" tabindex="-1"></a>  best_j_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(j_stats)</span>
<span id="cb51-47"><a href="#cb51-47" tabindex="-1"></a>  optimal_threshold <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>alpha.values)[best_j_idx]</span>
<span id="cb51-48"><a href="#cb51-48" tabindex="-1"></a>  all_thresholds[i] <span class="ot">&lt;-</span> optimal_threshold</span>
<span id="cb51-49"><a href="#cb51-49" tabindex="-1"></a>  test_j_stats[i] <span class="ot">&lt;-</span> j_stats[best_j_idx]</span>
<span id="cb51-50"><a href="#cb51-50" tabindex="-1"></a>  </span>
<span id="cb51-51"><a href="#cb51-51" tabindex="-1"></a>  <span class="co"># Create confusion matrix with optimal threshold (1-0 order with TP in top left)</span></span>
<span id="cb51-52"><a href="#cb51-52" tabindex="-1"></a>  pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(p <span class="sc">&gt;=</span> optimal_threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb51-53"><a href="#cb51-53" tabindex="-1"></a>  cm <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">factor</span>(test_y, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)), </span>
<span id="cb51-54"><a href="#cb51-54" tabindex="-1"></a>             <span class="fu">factor</span>(pred_class, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb51-55"><a href="#cb51-55" tabindex="-1"></a>  <span class="fu">colnames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Pred 1&quot;</span>, <span class="st">&quot;Pred 0&quot;</span>)</span>
<span id="cb51-56"><a href="#cb51-56" tabindex="-1"></a>  <span class="fu">rownames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;True 1&quot;</span>, <span class="st">&quot;True 0&quot;</span>)</span>
<span id="cb51-57"><a href="#cb51-57" tabindex="-1"></a>  confusion_matrices[[i]] <span class="ot">&lt;-</span> cm</span>
<span id="cb51-58"><a href="#cb51-58" tabindex="-1"></a>}</span>
<span id="cb51-59"><a href="#cb51-59" tabindex="-1"></a></span>
<span id="cb51-60"><a href="#cb51-60" tabindex="-1"></a><span class="co"># Calculate average confusion matrix</span></span>
<span id="cb51-61"><a href="#cb51-61" tabindex="-1"></a>avg_cm <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, confusion_matrices) <span class="sc">/</span> <span class="fu">length</span>(confusion_matrices)</span>
<span id="cb51-62"><a href="#cb51-62" tabindex="-1"></a></span>
<span id="cb51-63"><a href="#cb51-63" tabindex="-1"></a><span class="co"># Print final results</span></span>
<span id="cb51-64"><a href="#cb51-64" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Test Results over 100 iterations:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Test Results over 100 iterations:</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean AUC: 0.6719863</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD AUC:&quot;</span>, <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD AUC: 0.009754323</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Youden&#39;s J:&quot;</span>, <span class="fu">mean</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Youden&#39;s J: 0.2691155</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD Youden&#39;s J:&quot;</span>, <span class="fu">sd</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD Youden&#39;s J: 0.01939396</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Optimal Threshold:&quot;</span>, <span class="fu">mean</span>(all_thresholds), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Optimal Threshold: 0.521184</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;95% CI for AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), </span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>    <span class="st">&quot;to&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 95% CI for AUC: 0.6528678 to 0.6911048</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Average Confusion Matrix:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Average Confusion Matrix:</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a><span class="fu">print</span>(avg_cm)</span></code></pre></div>
<pre><code>##         
##          Pred 1 Pred 0
##   True 1 508.26 260.88
##   True 0 278.58 432.84</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a><span class="co"># Plotting AUC distribution - removed type=&quot;o&quot; to not connect dots</span></span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a><span class="fu">plot</span>(test_aucs, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch=</span><span class="dv">20</span>,</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;AUC Test Distribution&quot;</span>,</span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Iteration&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;AUC&quot;</span>)</span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb69-7"><a href="#cb69-7" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb69-8"><a href="#cb69-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb69-9"><a href="#cb69-9" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;AUC Values&quot;</span>, <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;95% CI Bounds&quot;</span>),</span>
<span id="cb69-10"><a href="#cb69-10" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>),</span>
<span id="cb69-11"><a href="#cb69-11" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb69-12"><a href="#cb69-12" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a><span class="co"># Plot ROC curve with confidence intervals</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>, </span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;False Positive Rate&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;True Positive Rate&quot;</span>,</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;ROC Curve&quot;</span>)</span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a><span class="co"># Calculate average ROC curve with confidence intervals</span></span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a>fpr_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a>tpr_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(performance_list), <span class="at">ncol =</span> <span class="fu">length</span>(fpr_grid))</span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(performance_list)) {</span>
<span id="cb70-11"><a href="#cb70-11" tabindex="-1"></a>  curve_i <span class="ot">&lt;-</span> performance_list[[i]]</span>
<span id="cb70-12"><a href="#cb70-12" tabindex="-1"></a>  tpr_matrix[i,] <span class="ot">&lt;-</span> <span class="fu">approx</span>(curve_i<span class="sc">@</span>x.values[[<span class="dv">1</span>]], </span>
<span id="cb70-13"><a href="#cb70-13" tabindex="-1"></a>                          curve_i<span class="sc">@</span>y.values[[<span class="dv">1</span>]], </span>
<span id="cb70-14"><a href="#cb70-14" tabindex="-1"></a>                          <span class="at">xout =</span> fpr_grid)<span class="sc">$</span>y</span>
<span id="cb70-15"><a href="#cb70-15" tabindex="-1"></a>}</span>
<span id="cb70-16"><a href="#cb70-16" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" tabindex="-1"></a>mean_tpr <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(tpr_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-18"><a href="#cb70-18" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, mean_tpr, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb70-19"><a href="#cb70-19" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" tabindex="-1"></a><span class="co"># Add optimal threshold point</span></span>
<span id="cb70-21"><a href="#cb70-21" tabindex="-1"></a>opt_point_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(fpr_grid <span class="sc">-</span> <span class="fu">mean</span>(all_thresholds)))</span>
<span id="cb70-22"><a href="#cb70-22" tabindex="-1"></a><span class="fu">points</span>(fpr_grid[opt_point_idx], mean_tpr[opt_point_idx], </span>
<span id="cb70-23"><a href="#cb70-23" tabindex="-1"></a>       <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb70-24"><a href="#cb70-24" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" tabindex="-1"></a><span class="co"># Add confidence interval</span></span>
<span id="cb70-26"><a href="#cb70-26" tabindex="-1"></a>ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb70-27"><a href="#cb70-27" tabindex="-1"></a>ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb70-28"><a href="#cb70-28" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, ci_lower, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb70-29"><a href="#cb70-29" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, ci_upper, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb70-30"><a href="#cb70-30" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" tabindex="-1"></a><span class="co"># Add legend</span></span>
<span id="cb70-32"><a href="#cb70-32" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb70-33"><a href="#cb70-33" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;Random&quot;</span>, <span class="st">&quot;Average ROC&quot;</span>, <span class="st">&quot;95% CI&quot;</span>, <span class="st">&quot;Optimal Threshold&quot;</span>),</span>
<span id="cb70-34"><a href="#cb70-34" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;gray&quot;</span>, <span class="st">&quot;blue&quot;</span>), </span>
<span id="cb70-35"><a href="#cb70-35" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="cn">NA</span>), </span>
<span id="cb70-36"><a href="#cb70-36" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">19</span>),</span>
<span id="cb70-37"><a href="#cb70-37" tabindex="-1"></a>       <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="cn">NA</span>))</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-7-2.png" width="672" /></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb71-6"><a href="#cb71-6" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" tabindex="-1"></a><span class="co"># Prepare the XGBoost matrices</span></span>
<span id="cb71-8"><a href="#cb71-8" tabindex="-1"></a>xs <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> . <span class="sc">-</span> <span class="dv">1</span> <span class="sc">-</span> conversion, <span class="at">data =</span> outcome_data)</span>
<span id="cb71-9"><a href="#cb71-9" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(outcome_data<span class="sc">$</span>conversion))</span>
<span id="cb71-10"><a href="#cb71-10" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" tabindex="-1"></a><span class="co"># Create parameter grid - only tune eta and nrounds</span></span>
<span id="cb71-12"><a href="#cb71-12" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb71-13"><a href="#cb71-13" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fu">seq</span>(<span class="fl">0.001</span>, <span class="fl">0.03</span>, <span class="at">by =</span> <span class="fl">0.01</span>),</span>
<span id="cb71-14"><a href="#cb71-14" tabindex="-1"></a>  <span class="at">nrounds =</span> <span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">500</span>, <span class="at">by =</span> <span class="dv">50</span>)</span>
<span id="cb71-15"><a href="#cb71-15" tabindex="-1"></a>)</span>
<span id="cb71-16"><a href="#cb71-16" tabindex="-1"></a></span>
<span id="cb71-17"><a href="#cb71-17" tabindex="-1"></a><span class="co"># Sample grid points</span></span>
<span id="cb71-18"><a href="#cb71-18" tabindex="-1"></a>conf_lev <span class="ot">&lt;-</span> .<span class="dv">95</span></span>
<span id="cb71-19"><a href="#cb71-19" tabindex="-1"></a>num_max <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb71-20"><a href="#cb71-20" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>conf_lev)<span class="sc">/</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>num_max<span class="sc">/</span><span class="fu">nrow</span>(grid)))</span>
<span id="cb71-21"><a href="#cb71-21" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(grid), n, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-22"><a href="#cb71-22" tabindex="-1"></a>rgrid <span class="ot">&lt;-</span> grid[ind, ]</span>
<span id="cb71-23"><a href="#cb71-23" tabindex="-1"></a></span>
<span id="cb71-24"><a href="#cb71-24" tabindex="-1"></a><span class="co"># Set up parallel processing</span></span>
<span id="cb71-25"><a href="#cb71-25" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb71-26"><a href="#cb71-26" tabindex="-1"></a></span>
<span id="cb71-27"><a href="#cb71-27" tabindex="-1"></a><span class="co"># Validation phase</span></span>
<span id="cb71-28"><a href="#cb71-28" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Phase 1: Validation Phase</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Phase 1: Validation Phase</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a>n_validations <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>validation_results <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(rgrid), <span class="at">ncol =</span> n_validations)</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a>validation_j_stats <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(rgrid), <span class="at">ncol =</span> n_validations)</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(rgrid)) {</span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a>  <span class="co">#cat(&quot;\nTesting parameter set&quot;, j, &quot;of&quot;, nrow(rgrid), &quot;\n&quot;)</span></span>
<span id="cb73-7"><a href="#cb73-7" tabindex="-1"></a>  <span class="co">#cat(&quot;eta =&quot;, rgrid[j, &quot;eta&quot;], &quot;, nrounds =&quot;, rgrid[j, &quot;nrounds&quot;], &quot;\n&quot;)</span></span>
<span id="cb73-8"><a href="#cb73-8" tabindex="-1"></a>  </span>
<span id="cb73-9"><a href="#cb73-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_validations) {</span>
<span id="cb73-10"><a href="#cb73-10" tabindex="-1"></a>    <span class="co"># Create validation split</span></span>
<span id="cb73-11"><a href="#cb73-11" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sample</span>(<span class="fu">nrow</span>(xs), <span class="fu">nrow</span>(xs), T))</span>
<span id="cb73-12"><a href="#cb73-12" tabindex="-1"></a>    train_x <span class="ot">&lt;-</span> xs[idx, ]</span>
<span id="cb73-13"><a href="#cb73-13" tabindex="-1"></a>    train_y <span class="ot">&lt;-</span> y[idx]</span>
<span id="cb73-14"><a href="#cb73-14" tabindex="-1"></a>    val_x <span class="ot">&lt;-</span> xs[<span class="sc">-</span>idx, ]</span>
<span id="cb73-15"><a href="#cb73-15" tabindex="-1"></a>    val_y <span class="ot">&lt;-</span> y[<span class="sc">-</span>idx]</span>
<span id="cb73-16"><a href="#cb73-16" tabindex="-1"></a>    </span>
<span id="cb73-17"><a href="#cb73-17" tabindex="-1"></a>    prm <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb73-18"><a href="#cb73-18" tabindex="-1"></a>      <span class="at">booster =</span> <span class="st">&quot;gblinear&quot;</span>,</span>
<span id="cb73-19"><a href="#cb73-19" tabindex="-1"></a>      <span class="at">objective =</span> <span class="st">&quot;binary:logistic&quot;</span>,</span>
<span id="cb73-20"><a href="#cb73-20" tabindex="-1"></a>      <span class="at">eta =</span> rgrid[j, <span class="st">&quot;eta&quot;</span>],</span>
<span id="cb73-21"><a href="#cb73-21" tabindex="-1"></a>      <span class="at">nthread =</span> nc</span>
<span id="cb73-22"><a href="#cb73-22" tabindex="-1"></a>    )</span>
<span id="cb73-23"><a href="#cb73-23" tabindex="-1"></a>    </span>
<span id="cb73-24"><a href="#cb73-24" tabindex="-1"></a>    dm_train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> train_x, <span class="at">label =</span> train_y)</span>
<span id="cb73-25"><a href="#cb73-25" tabindex="-1"></a>    mdl <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb73-26"><a href="#cb73-26" tabindex="-1"></a>      <span class="at">params =</span> prm,</span>
<span id="cb73-27"><a href="#cb73-27" tabindex="-1"></a>      <span class="at">data =</span> dm_train,</span>
<span id="cb73-28"><a href="#cb73-28" tabindex="-1"></a>      <span class="at">nrounds =</span> rgrid[j, <span class="st">&quot;nrounds&quot;</span>],</span>
<span id="cb73-29"><a href="#cb73-29" tabindex="-1"></a>      <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb73-30"><a href="#cb73-30" tabindex="-1"></a>    )</span>
<span id="cb73-31"><a href="#cb73-31" tabindex="-1"></a>    </span>
<span id="cb73-32"><a href="#cb73-32" tabindex="-1"></a>    <span class="co"># Get predictions and ROC metrics</span></span>
<span id="cb73-33"><a href="#cb73-33" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl, <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> val_x))</span>
<span id="cb73-34"><a href="#cb73-34" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(p, val_y)</span>
<span id="cb73-35"><a href="#cb73-35" tabindex="-1"></a>    </span>
<span id="cb73-36"><a href="#cb73-36" tabindex="-1"></a>    <span class="co"># Calculate AUC</span></span>
<span id="cb73-37"><a href="#cb73-37" tabindex="-1"></a>    validation_results[j, i] <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb73-38"><a href="#cb73-38" tabindex="-1"></a>    </span>
<span id="cb73-39"><a href="#cb73-39" tabindex="-1"></a>    <span class="co"># Calculate Youden&#39;s J Statistic</span></span>
<span id="cb73-40"><a href="#cb73-40" tabindex="-1"></a>    roc <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;tpr&quot;</span>, <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb73-41"><a href="#cb73-41" tabindex="-1"></a>    tpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(roc<span class="sc">@</span>y.values)</span>
<span id="cb73-42"><a href="#cb73-42" tabindex="-1"></a>    fpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(roc<span class="sc">@</span>x.values)</span>
<span id="cb73-43"><a href="#cb73-43" tabindex="-1"></a>    j_stats <span class="ot">&lt;-</span> tpr <span class="sc">-</span> fpr</span>
<span id="cb73-44"><a href="#cb73-44" tabindex="-1"></a>    validation_j_stats[j, i] <span class="ot">&lt;-</span> <span class="fu">max</span>(j_stats)</span>
<span id="cb73-45"><a href="#cb73-45" tabindex="-1"></a>  }</span>
<span id="cb73-46"><a href="#cb73-46" tabindex="-1"></a>  </span>
<span id="cb73-47"><a href="#cb73-47" tabindex="-1"></a>  <span class="co">#cat(&quot;Mean AUC:&quot;, mean(validation_results[j,]), &quot;\n&quot;)</span></span>
<span id="cb73-48"><a href="#cb73-48" tabindex="-1"></a>  <span class="co">#cat(&quot;SD AUC:&quot;, sd(validation_results[j,]), &quot;\n&quot;)</span></span>
<span id="cb73-49"><a href="#cb73-49" tabindex="-1"></a>  <span class="co">#cat(&quot;Mean J statistic:&quot;, mean(validation_j_stats[j,]), &quot;\n&quot;)</span></span>
<span id="cb73-50"><a href="#cb73-50" tabindex="-1"></a>}</span>
<span id="cb73-51"><a href="#cb73-51" tabindex="-1"></a></span>
<span id="cb73-52"><a href="#cb73-52" tabindex="-1"></a><span class="co"># Select best parameters based on validation AUC</span></span>
<span id="cb73-53"><a href="#cb73-53" tabindex="-1"></a>best_params_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">rowMeans</span>(validation_results))</span>
<span id="cb73-54"><a href="#cb73-54" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> rgrid[best_params_idx,]</span>
<span id="cb73-55"><a href="#cb73-55" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Best parameters:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Best parameters:</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="fu">print</span>(best_params)</span></code></pre></div>
<pre><code>##      eta nrounds
## 14 0.011     250</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="co"># Run X tests with best parameters</span></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Running X test iterations with best parameters...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Running X test iterations with best parameters...</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>test_aucs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>test_j_stats <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a>confusion_matrices <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a>performance_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>all_thresholds <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a><span class="co"># Train final model with best parameters</span></span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>best_params_list <span class="ot">&lt;-</span> <span class="fu">as.list</span>(best_params[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(best_params) <span class="sc">==</span> <span class="st">&quot;nrounds&quot;</span>)])</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a>best_params_list<span class="sc">$</span>booster <span class="ot">&lt;-</span> <span class="st">&quot;gblinear&quot;</span></span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a>best_params_list<span class="sc">$</span>objective <span class="ot">&lt;-</span> <span class="st">&quot;binary:logistic&quot;</span></span>
<span id="cb79-11"><a href="#cb79-11" tabindex="-1"></a>best_params_list<span class="sc">$</span>nthread <span class="ot">&lt;-</span> nc</span>
<span id="cb79-12"><a href="#cb79-12" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) {</span>
<span id="cb79-14"><a href="#cb79-14" tabindex="-1"></a>  <span class="co">#cat(&quot;\nIteration&quot;, i, &quot;of 100\n&quot;)       </span></span>
<span id="cb79-15"><a href="#cb79-15" tabindex="-1"></a>  <span class="co"># Create test split</span></span>
<span id="cb79-16"><a href="#cb79-16" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sample</span>(<span class="fu">nrow</span>(xs), <span class="fu">nrow</span>(xs), T))</span>
<span id="cb79-17"><a href="#cb79-17" tabindex="-1"></a>  train_x <span class="ot">&lt;-</span> xs[idx, ]</span>
<span id="cb79-18"><a href="#cb79-18" tabindex="-1"></a>  train_y <span class="ot">&lt;-</span> y[idx]</span>
<span id="cb79-19"><a href="#cb79-19" tabindex="-1"></a>  test_x <span class="ot">&lt;-</span> xs[<span class="sc">-</span>idx, ]</span>
<span id="cb79-20"><a href="#cb79-20" tabindex="-1"></a>  test_y <span class="ot">&lt;-</span> y[<span class="sc">-</span>idx]</span>
<span id="cb79-21"><a href="#cb79-21" tabindex="-1"></a>  </span>
<span id="cb79-22"><a href="#cb79-22" tabindex="-1"></a>  <span class="co"># Train model</span></span>
<span id="cb79-23"><a href="#cb79-23" tabindex="-1"></a>  dm_train <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> train_x, <span class="at">label =</span> train_y)</span>
<span id="cb79-24"><a href="#cb79-24" tabindex="-1"></a>  mdl <span class="ot">&lt;-</span> <span class="fu">xgb.train</span>(</span>
<span id="cb79-25"><a href="#cb79-25" tabindex="-1"></a>    <span class="at">params =</span> best_params_list,</span>
<span id="cb79-26"><a href="#cb79-26" tabindex="-1"></a>    <span class="at">data =</span> dm_train,</span>
<span id="cb79-27"><a href="#cb79-27" tabindex="-1"></a>    <span class="at">nrounds =</span> best_params[[<span class="st">&quot;nrounds&quot;</span>]],</span>
<span id="cb79-28"><a href="#cb79-28" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb79-29"><a href="#cb79-29" tabindex="-1"></a>  )</span>
<span id="cb79-30"><a href="#cb79-30" tabindex="-1"></a>  </span>
<span id="cb79-31"><a href="#cb79-31" tabindex="-1"></a>  <span class="co"># Get predictions</span></span>
<span id="cb79-32"><a href="#cb79-32" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl, <span class="fu">xgb.DMatrix</span>(<span class="at">data =</span> test_x))</span>
<span id="cb79-33"><a href="#cb79-33" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(p, test_y)</span>
<span id="cb79-34"><a href="#cb79-34" tabindex="-1"></a>  </span>
<span id="cb79-35"><a href="#cb79-35" tabindex="-1"></a>  <span class="co"># Calculate AUC</span></span>
<span id="cb79-36"><a href="#cb79-36" tabindex="-1"></a>  test_aucs[i] <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;auc&quot;</span>)<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb79-37"><a href="#cb79-37" tabindex="-1"></a>  </span>
<span id="cb79-38"><a href="#cb79-38" tabindex="-1"></a>  <span class="co"># Calculate ROC curve and store</span></span>
<span id="cb79-39"><a href="#cb79-39" tabindex="-1"></a>  perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="st">&quot;tpr&quot;</span>, <span class="st">&quot;fpr&quot;</span>)</span>
<span id="cb79-40"><a href="#cb79-40" tabindex="-1"></a>  performance_list[[i]] <span class="ot">&lt;-</span> perf</span>
<span id="cb79-41"><a href="#cb79-41" tabindex="-1"></a>  </span>
<span id="cb79-42"><a href="#cb79-42" tabindex="-1"></a>  <span class="co"># Find optimal threshold using Youden&#39;s J statistic</span></span>
<span id="cb79-43"><a href="#cb79-43" tabindex="-1"></a>  tpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>y.values)</span>
<span id="cb79-44"><a href="#cb79-44" tabindex="-1"></a>  fpr <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>x.values)</span>
<span id="cb79-45"><a href="#cb79-45" tabindex="-1"></a>  j_stats <span class="ot">&lt;-</span> tpr <span class="sc">-</span> fpr</span>
<span id="cb79-46"><a href="#cb79-46" tabindex="-1"></a>  best_j_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(j_stats)</span>
<span id="cb79-47"><a href="#cb79-47" tabindex="-1"></a>  optimal_threshold <span class="ot">&lt;-</span> <span class="fu">unlist</span>(perf<span class="sc">@</span>alpha.values)[best_j_idx]</span>
<span id="cb79-48"><a href="#cb79-48" tabindex="-1"></a>  all_thresholds[i] <span class="ot">&lt;-</span> optimal_threshold</span>
<span id="cb79-49"><a href="#cb79-49" tabindex="-1"></a>  test_j_stats[i] <span class="ot">&lt;-</span> j_stats[best_j_idx]</span>
<span id="cb79-50"><a href="#cb79-50" tabindex="-1"></a>  </span>
<span id="cb79-51"><a href="#cb79-51" tabindex="-1"></a>  <span class="co"># Create confusion matrix with optimal threshold (1-0 order with TP in top left)</span></span>
<span id="cb79-52"><a href="#cb79-52" tabindex="-1"></a>  pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(p <span class="sc">&gt;=</span> optimal_threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb79-53"><a href="#cb79-53" tabindex="-1"></a>  cm <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">factor</span>(test_y, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)), </span>
<span id="cb79-54"><a href="#cb79-54" tabindex="-1"></a>             <span class="fu">factor</span>(pred_class, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb79-55"><a href="#cb79-55" tabindex="-1"></a>  <span class="fu">colnames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Pred 1&quot;</span>, <span class="st">&quot;Pred 0&quot;</span>)</span>
<span id="cb79-56"><a href="#cb79-56" tabindex="-1"></a>  <span class="fu">rownames</span>(cm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;True 1&quot;</span>, <span class="st">&quot;True 0&quot;</span>)</span>
<span id="cb79-57"><a href="#cb79-57" tabindex="-1"></a>  confusion_matrices[[i]] <span class="ot">&lt;-</span> cm</span>
<span id="cb79-58"><a href="#cb79-58" tabindex="-1"></a>}</span>
<span id="cb79-59"><a href="#cb79-59" tabindex="-1"></a></span>
<span id="cb79-60"><a href="#cb79-60" tabindex="-1"></a><span class="co"># Calculate average confusion matrix</span></span>
<span id="cb79-61"><a href="#cb79-61" tabindex="-1"></a>avg_cm <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="st">&#39;+&#39;</span>, confusion_matrices) <span class="sc">/</span> <span class="fu">length</span>(confusion_matrices)</span>
<span id="cb79-62"><a href="#cb79-62" tabindex="-1"></a></span>
<span id="cb79-63"><a href="#cb79-63" tabindex="-1"></a><span class="co"># Print final results</span></span>
<span id="cb79-64"><a href="#cb79-64" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Test Results over 100 iterations:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Test Results over 100 iterations:</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean AUC: 0.680117</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD AUC:&quot;</span>, <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD AUC: 0.01082739</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Youden&#39;s J:&quot;</span>, <span class="fu">mean</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Youden&#39;s J: 0.2804939</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SD Youden&#39;s J:&quot;</span>, <span class="fu">sd</span>(test_j_stats), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## SD Youden&#39;s J: 0.01837918</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Mean Optimal Threshold:&quot;</span>, <span class="fu">mean</span>(all_thresholds), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Mean Optimal Threshold: 0.5154228</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;95% CI for AUC:&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), </span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>    <span class="st">&quot;to&quot;</span>, <span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 95% CI for AUC: 0.6588953 to 0.7013387</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Average Confusion Matrix:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## 
## Average Confusion Matrix:</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="fu">print</span>(avg_cm)</span></code></pre></div>
<pre><code>##         
##          Pred 1 Pred 0
##   True 1 527.32 241.22
##   True 0 288.72 422.70</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a><span class="co"># Plotting AUC distribution - removed type=&quot;o&quot; to not connect dots</span></span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a><span class="fu">plot</span>(test_aucs, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch=</span><span class="dv">20</span>,</span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;AUC Test Distribution&quot;</span>,</span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Iteration&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;AUC&quot;</span>)</span>
<span id="cb97-5"><a href="#cb97-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb97-6"><a href="#cb97-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb97-7"><a href="#cb97-7" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(test_aucs) <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fu">sd</span>(test_aucs), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb97-8"><a href="#cb97-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb97-9"><a href="#cb97-9" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;AUC Values&quot;</span>, <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;95% CI Bounds&quot;</span>),</span>
<span id="cb97-10"><a href="#cb97-10" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>),</span>
<span id="cb97-11"><a href="#cb97-11" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb97-12"><a href="#cb97-12" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="dv">20</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a><span class="co"># Plot ROC curve with confidence intervals</span></span>
<span id="cb98-2"><a href="#cb98-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>, </span>
<span id="cb98-3"><a href="#cb98-3" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;False Positive Rate&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;True Positive Rate&quot;</span>,</span>
<span id="cb98-4"><a href="#cb98-4" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;ROC Curve&quot;</span>)</span>
<span id="cb98-5"><a href="#cb98-5" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" tabindex="-1"></a><span class="co"># Calculate average ROC curve with confidence intervals</span></span>
<span id="cb98-7"><a href="#cb98-7" tabindex="-1"></a>fpr_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb98-8"><a href="#cb98-8" tabindex="-1"></a>tpr_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(performance_list), <span class="at">ncol =</span> <span class="fu">length</span>(fpr_grid))</span>
<span id="cb98-9"><a href="#cb98-9" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(performance_list)) {</span>
<span id="cb98-11"><a href="#cb98-11" tabindex="-1"></a>  curve_i <span class="ot">&lt;-</span> performance_list[[i]]</span>
<span id="cb98-12"><a href="#cb98-12" tabindex="-1"></a>  tpr_matrix[i,] <span class="ot">&lt;-</span> <span class="fu">approx</span>(curve_i<span class="sc">@</span>x.values[[<span class="dv">1</span>]], </span>
<span id="cb98-13"><a href="#cb98-13" tabindex="-1"></a>                          curve_i<span class="sc">@</span>y.values[[<span class="dv">1</span>]], </span>
<span id="cb98-14"><a href="#cb98-14" tabindex="-1"></a>                          <span class="at">xout =</span> fpr_grid)<span class="sc">$</span>y</span>
<span id="cb98-15"><a href="#cb98-15" tabindex="-1"></a>}</span>
<span id="cb98-16"><a href="#cb98-16" tabindex="-1"></a></span>
<span id="cb98-17"><a href="#cb98-17" tabindex="-1"></a>mean_tpr <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(tpr_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb98-18"><a href="#cb98-18" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, mean_tpr, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb98-19"><a href="#cb98-19" tabindex="-1"></a></span>
<span id="cb98-20"><a href="#cb98-20" tabindex="-1"></a><span class="co"># Add optimal threshold point</span></span>
<span id="cb98-21"><a href="#cb98-21" tabindex="-1"></a>opt_point_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(fpr_grid <span class="sc">-</span> <span class="fu">mean</span>(all_thresholds)))</span>
<span id="cb98-22"><a href="#cb98-22" tabindex="-1"></a><span class="fu">points</span>(fpr_grid[opt_point_idx], mean_tpr[opt_point_idx], </span>
<span id="cb98-23"><a href="#cb98-23" tabindex="-1"></a>       <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb98-24"><a href="#cb98-24" tabindex="-1"></a></span>
<span id="cb98-25"><a href="#cb98-25" tabindex="-1"></a><span class="co"># Add confidence interval</span></span>
<span id="cb98-26"><a href="#cb98-26" tabindex="-1"></a>ci_lower <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb98-27"><a href="#cb98-27" tabindex="-1"></a>ci_upper <span class="ot">&lt;-</span> <span class="fu">apply</span>(tpr_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb98-28"><a href="#cb98-28" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, ci_lower, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb98-29"><a href="#cb98-29" tabindex="-1"></a><span class="fu">lines</span>(fpr_grid, ci_upper, <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb98-30"><a href="#cb98-30" tabindex="-1"></a></span>
<span id="cb98-31"><a href="#cb98-31" tabindex="-1"></a><span class="co"># Add legend</span></span>
<span id="cb98-32"><a href="#cb98-32" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, </span>
<span id="cb98-33"><a href="#cb98-33" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;Random&quot;</span>, <span class="st">&quot;Average ROC&quot;</span>, <span class="st">&quot;95% CI&quot;</span>, <span class="st">&quot;Optimal Threshold&quot;</span>),</span>
<span id="cb98-34"><a href="#cb98-34" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;gray&quot;</span>, <span class="st">&quot;blue&quot;</span>), </span>
<span id="cb98-35"><a href="#cb98-35" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="cn">NA</span>), </span>
<span id="cb98-36"><a href="#cb98-36" tabindex="-1"></a>       <span class="at">pch=</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">19</span>),</span>
<span id="cb98-37"><a href="#cb98-37" tabindex="-1"></a>       <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="cn">NA</span>))</span></code></pre></div>
<p><img src="xgboost_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>

<div id="rmd-source-code">LS0tDQp0aXRsZTogIlhHQm9vc3QgUHJlZGljdGlvbiBNb2RlbCINCm91dHB1dDogaHRtbF9kb2N1bWVudA0KLS0tDQoNCg0KYGBge3Igb3B0aW9ucywgaW5jbHVkZT1GQUxTRX0NCm9wdGlvbnMobWF4LnByaW50PTEwMDAwKQ0KYGBgDQoNCmBgYHtyfQ0KbGlicmFyeShkYXRhLnRhYmxlKSAgIA0KDQpvdXRjb21lX2RhdGEgPC0gZnJlYWQoInByZWRpY3Rfb3V0Y29tZS5jc3YuZ3oiKQ0KDQojIEZpbHRlciBvdXQgeWVhcipfdGVhbSBjb2x1bW5zDQp5ZWFyX2NvbHMgPC0gZ3JlcCgiXnllYXJbMC05XStfdGVhbSIsIG5hbWVzKG91dGNvbWVfZGF0YSksIHZhbHVlID0gVFJVRSkNCm91dGNvbWVfZGF0YVssICh5ZWFyX2NvbHMpIDo9IE5VTExdDQpgYGANCg0KYGBge3J9DQojIEZ1bmN0aW9uIHRvIGNoZWNrIGNvbHVtbiB2YXJpYW5jZSBhbmQgb3RoZXIgcG90ZW50aWFsIGlzc3Vlcw0KY2hlY2tfY29sdW1ucyA8LSBmdW5jdGlvbihkdCkgew0KICAjIENyZWF0ZSBhIGxpc3QgdG8gc3RvcmUgcmVzdWx0cw0KICBjb2xfaXNzdWVzIDwtIGxpc3QoDQogICAgemVyb192YXIgPSBjaGFyYWN0ZXIoKSwNCiAgICBhbGxfbmEgPSBjaGFyYWN0ZXIoKSwNCiAgICBwZXJmZWN0X2NvciA9IGNoYXJhY3RlcigpLA0KICAgIGNoYXJhY3Rlcl9jb2xzID0gY2hhcmFjdGVyKCkNCiAgKQ0KICANCiAgIyBGaXJzdCwgaWRlbnRpZnkgY2hhcmFjdGVyIGNvbHVtbnMgKGV4Y2VwdCBteV9pZCkNCiAgZm9yKGNvbCBpbiBuYW1lcyhkdCkpIHsNCiAgICBpZihpcy5jaGFyYWN0ZXIoZHRbW2NvbF1dKSAmJiBjb2wgIT0gIm15X2lkIikgew0KICAgICAgY29sX2lzc3VlcyRjaGFyYWN0ZXJfY29scyA8LSBjKGNvbF9pc3N1ZXMkY2hhcmFjdGVyX2NvbHMsIGNvbCkNCiAgICB9DQogIH0NCiAgDQogICMgR2V0IG51bWVyaWMgY29sdW1ucyBvbmx5DQogIG51bWVyaWNfY29scyA8LSBuYW1lcyhkdClbc2FwcGx5KGR0LCBpcy5udW1lcmljKV0NCiAgbnVtZXJpY19jb2xzIDwtIHNldGRpZmYobnVtZXJpY19jb2xzLCAiY29udmVyc2lvbiIpICAjIGV4Y2x1ZGUgdGFyZ2V0IHZhcmlhYmxlDQogIA0KICAjIENoZWNrIGVhY2ggbnVtZXJpYyBjb2x1bW4NCiAgZm9yKGNvbCBpbiBudW1lcmljX2NvbHMpIHsNCiAgICAjIEdldCBjb2x1bW4gZGF0YSB3aXRob3V0IE5Bcw0KICAgIGNvbF9kYXRhIDwtIGR0W1tjb2xdXVshaXMubmEoZHRbW2NvbF1dKV0NCiAgICANCiAgICAjIENoZWNrIGZvciB6ZXJvIHZhcmlhbmNlDQogICAgaWYobGVuZ3RoKHVuaXF1ZShjb2xfZGF0YSkpID09IDEpIHsNCiAgICAgIGNvbF9pc3N1ZXMkemVyb192YXIgPC0gYyhjb2xfaXNzdWVzJHplcm9fdmFyLCBjb2wpDQogICAgICBuZXh0DQogICAgfQ0KICAgIA0KICAgICMgQ2hlY2sgZm9yIGFsbCBOQQ0KICAgIGlmKGFsbChpcy5uYShkdFtbY29sXV0pKSkgew0KICAgICAgY29sX2lzc3VlcyRhbGxfbmEgPC0gYyhjb2xfaXNzdWVzJGFsbF9uYSwgY29sKQ0KICAgIH0NCiAgfQ0KICANCiAgIyBDaGVjayBjb3JyZWxhdGlvbnMgZm9yIHJlbWFpbmluZyBudW1lcmljIGNvbHVtbnMNCiAgcmVtYWluaW5nX2NvbHMgPC0gc2V0ZGlmZihudW1lcmljX2NvbHMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWUoYyhjb2xfaXNzdWVzJHplcm9fdmFyLCBjb2xfaXNzdWVzJGFsbF9uYSkpKQ0KICANCiAgaWYobGVuZ3RoKHJlbWFpbmluZ19jb2xzKSA+IDEpIHsNCiAgICAjIENyZWF0ZSBjb3JyZWxhdGlvbiBtYXRyaXgNCiAgICBjb3JfbWF0cml4IDwtIGNvcihkdFssIC4ucmVtYWluaW5nX2NvbHNdLCB1c2UgPSAicGFpcndpc2UuY29tcGxldGUub2JzIikNCiAgICANCiAgICAjIEZpbmQgaGlnaGx5IGNvcnJlbGF0ZWQgcGFpcnMNCiAgICBmb3IoaSBpbiAxOihsZW5ndGgocmVtYWluaW5nX2NvbHMpLTEpKSB7DQogICAgICBmb3IoaiBpbiAoaSsxKTpsZW5ndGgocmVtYWluaW5nX2NvbHMpKSB7DQogICAgICAgIGlmKCFpcy5uYShjb3JfbWF0cml4W2ksal0pICYmIGFicyhjb3JfbWF0cml4W2ksal0pID4gMC45OTk5KSB7DQogICAgICAgICAgY29sX2lzc3VlcyRwZXJmZWN0X2NvciA8LSBjKGNvbF9pc3N1ZXMkcGVyZmVjdF9jb3IsIHJlbWFpbmluZ19jb2xzW2pdKQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICB9DQogIA0KICByZXR1cm4oY29sX2lzc3VlcykNCn0NCg0KIyBGaW5kIHByb2JsZW1hdGljIGNvbHVtbnMNCmlzc3VlcyA8LSBjaGVja19jb2x1bW5zKG91dGNvbWVfZGF0YSkNCg0KIyBQcmludCBzdW1tYXJ5IG9mIGlzc3VlcyBmb3VuZA0KY2F0KCJGb3VuZCB0aGUgZm9sbG93aW5nIGlzc3VlczpcbiIpDQppZihsZW5ndGgoaXNzdWVzJGNoYXJhY3Rlcl9jb2xzKSA+IDApIHsNCiAgY2F0KCJcbkNoYXJhY3RlciBjb2x1bW5zIChleGNsdWRpbmcgbXlfaWQpOiIsIHBhc3RlKGlzc3VlcyRjaGFyYWN0ZXJfY29scywgY29sbGFwc2U9IiwgIikpDQp9DQppZihsZW5ndGgoaXNzdWVzJHplcm9fdmFyKSA+IDApIHsNCiAgY2F0KCJcblplcm8gdmFyaWFuY2UgY29sdW1uczoiLCBwYXN0ZShpc3N1ZXMkemVyb192YXIsIGNvbGxhcHNlPSIsICIpKQ0KfQ0KaWYobGVuZ3RoKGlzc3VlcyRhbGxfbmEpID4gMCkgew0KICBjYXQoIlxuQWxsIE5BIGNvbHVtbnM6IiwgcGFzdGUoaXNzdWVzJGFsbF9uYSwgY29sbGFwc2U9IiwgIikpDQp9DQppZihsZW5ndGgoaXNzdWVzJHBlcmZlY3RfY29yKSA+IDApIHsNCiAgY2F0KCJcblBlcmZlY3RseSBjb3JyZWxhdGVkIGNvbHVtbnM6IiwgcGFzdGUodW5pcXVlKGlzc3VlcyRwZXJmZWN0X2NvciksIGNvbGxhcHNlPSIsICIpKQ0KfQ0KDQojIENvbWJpbmUgYWxsIHByb2JsZW1hdGljIGNvbHVtbnMNCnByb2JsZW1fY29scyA8LSB1bmlxdWUoYyhpc3N1ZXMkemVyb192YXIsIGlzc3VlcyRhbGxfbmEsIA0KICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVzJHBlcmZlY3RfY29yLCBpc3N1ZXMkY2hhcmFjdGVyX2NvbHMpKQ0KDQojIFJlbW92ZSBwcm9ibGVtYXRpYyBjb2x1bW5zDQppZihsZW5ndGgocHJvYmxlbV9jb2xzKSA+IDApIHsNCiAgb3V0Y29tZV9kYXRhWywgKHByb2JsZW1fY29scykgOj0gTlVMTF0NCn0NCg0KIyBQcmludCBzdW1tYXJ5IG9mIHJlbWFpbmluZyBjb2x1bW5zDQpjYXQoIlxuXG5SZW1vdmVkIiwgbGVuZ3RoKHByb2JsZW1fY29scyksICJwcm9ibGVtYXRpYyBjb2x1bW5zIikNCmNhdCgiXG5SZW1haW5pbmcgY29sdW1uczoiLCBuY29sKG91dGNvbWVfZGF0YSkpDQpgYGANCg0KDQoNCg0KYGBge3J9DQojIExvYWQgbGlicmFyeSBhbmQgcHJlcGFyZSBkYXRhDQojbGlicmFyeShyYW5kb21Gb3Jlc3QpDQojcmZfZGF0YSA8LSBjb3B5KG91dGNvbWVfZGF0YSlbLCBteV9pZCA6PSBOVUxMXQ0KI3JmX2RhdGFbLCBjb252ZXJzaW9uIDo9IGFzLmZhY3Rvcihjb252ZXJzaW9uKV0NCg0KIyBSdW4gUkYgYW5kIGdldCBPT0IgQVVDDQojcmZfbW9kZWwgPC0gcmFuZG9tRm9yZXN0KGNvbnZlcnNpb24gfiAuLCBkYXRhID0gcmZfZGF0YSwgbnRyZWUgPSAxMDAsIGltcG9ydGFuY2UgPSBUUlVFKQ0KI3ByZWRfb29iIDwtIHByZWRpY3QocmZfbW9kZWwsIHR5cGUgPSAicHJvYiIpWywyXQ0KI2NhdCgiXG5PT0IgQVVDOiIsIGFzLm51bWVyaWMocGVyZm9ybWFuY2UocHJlZGljdGlvbihwcmVkX29vYiwgYXMubnVtZXJpYyhhcy5jaGFyYWN0ZXIocmZfZGF0YSRjb252ZXJzaW9uKSkpLCAiYXVjIilAeS52YWx1ZXMpKQ0KDQojIEZpbHRlciB2YXJpYWJsZXMgYmFzZWQgb24gcG9zaXRpdmUgTURBDQojbWRhX3Njb3JlcyA8LSBpbXBvcnRhbmNlKHJmX21vZGVsKVssICJNZWFuRGVjcmVhc2VBY2N1cmFjeSJdDQoja2VlcF92YXJzIDwtIHVuaXF1ZShjKG5hbWVzKG1kYV9zY29yZXNbbWRhX3Njb3JlcyA+IDBdKSwgIm15X2lkIiwgImNvbnZlcnNpb24iKSkNCiNvdXRjb21lX2RhdGEgPC0gb3V0Y29tZV9kYXRhWywgLlNELCAuU0Rjb2xzID0ga2VlcF92YXJzXQ0KDQojY2F0KCJcblZhcmlhYmxlcyBrZXB0OiIsIGxlbmd0aChrZWVwX3ZhcnMpLCAib3V0IG9mIiwgbmNvbChyZl9kYXRhKSArIDEpDQpgYGANCg0KYGBge3J9DQpsaWJyYXJ5KHJhbmRvbUZvcmVzdCkNCmxpYnJhcnkoUk9DUikgICMgQWRkZWQgdGhpcyBsaWJyYXJ5DQoNCiMgSW5pdGlhbGl6ZSB2YXJpYWJsZXMgZm9yIFJGIGxvb3ANCnJmX2RhdGEgPC0gY29weShvdXRjb21lX2RhdGEpWywgbXlfaWQgOj0gTlVMTF0NCnJmX2RhdGFbLCBjb252ZXJzaW9uIDo9IGFzLmZhY3Rvcihjb252ZXJzaW9uKV0NCmJlc3RfYXVjIDwtIDANCnByZXZpb3VzX2RhdGEgPC0gTlVMTA0KDQojIEl0ZXJhdGl2ZSBSRiBwcm9jZXNzIGZvciB2YXJpYWJsZSBzZWxlY3Rpb24NCndoaWxlKFRSVUUpIHsNCiAgICAjIFJ1biBSRg0KICAgIHJmX21vZGVsIDwtIHJhbmRvbUZvcmVzdChjb252ZXJzaW9uIH4gLiwgZGF0YSA9IHJmX2RhdGEsIG50cmVlID0gMTAwLCBpbXBvcnRhbmNlID0gVFJVRSkNCiAgICBwcmVkX29vYiA8LSBwcmVkaWN0KHJmX21vZGVsLCB0eXBlID0gInByb2IiKVssMl0NCiAgICANCiAgICAjIENhbGN1bGF0ZSBPT0IgQVVDIHVzaW5nIFJPQ1INCiAgICBwcmVkIDwtIHByZWRpY3Rpb24ocHJlZF9vb2IsIGFzLm51bWVyaWMoYXMuY2hhcmFjdGVyKHJmX2RhdGEkY29udmVyc2lvbikpKQ0KICAgIGN1cnJlbnRfYXVjIDwtIGFzLm51bWVyaWMocGVyZm9ybWFuY2UocHJlZCwgImF1YyIpQHkudmFsdWVzKQ0KICAgIA0KICAgIGNhdCgiXG5DdXJyZW50IEFVQzoiLCByb3VuZChjdXJyZW50X2F1YywgNCksICJ3aXRoIiwgbmNvbChyZl9kYXRhKS0xLCAidmFyaWFibGVzIikNCiAgICANCiAgICAjIENoZWNrIGlmIEFVQyBkcm9wcGVkDQogICAgaWYoIWlzLm51bGwocHJldmlvdXNfZGF0YSkgJiYgY3VycmVudF9hdWMgPCBiZXN0X2F1Yykgew0KICAgICAgICBjYXQoIlxuQVVDIGRyb3BwZWQsIHJldmVydGluZyB0byBwcmV2aW91cyBzdGF0ZSIpDQogICAgICAgIG91dGNvbWVfZGF0YSA8LSBwcmV2aW91c19kYXRhDQogICAgICAgIGJyZWFrDQogICAgfQ0KICAgIA0KICAgICMgVXBkYXRlIGJlc3QgYW5kIHByZXBhcmUgZm9yIG5leHQgaXRlcmF0aW9uDQogICAgaWYoY3VycmVudF9hdWMgPiBiZXN0X2F1Yykgew0KICAgICAgICBiZXN0X2F1YyA8LSBjdXJyZW50X2F1Yw0KICAgICAgICBwcmV2aW91c19kYXRhIDwtIGNvcHkob3V0Y29tZV9kYXRhKQ0KICAgIH0NCiAgICANCiAgICAjIEZpbHRlciB2YXJpYWJsZXMgYmFzZWQgb24gcG9zaXRpdmUgTURBDQogICAgbWRhX3Njb3JlcyA8LSBpbXBvcnRhbmNlKHJmX21vZGVsKVssICJNZWFuRGVjcmVhc2VBY2N1cmFjeSJdDQogICAga2VlcF92YXJzIDwtIHVuaXF1ZShjKG5hbWVzKG1kYV9zY29yZXNbbWRhX3Njb3JlcyA+IDBdKSwgIm15X2lkIiwgImNvbnZlcnNpb24iKSkNCiAgICANCiAgICAjIFVwZGF0ZSBkYXRhIGZvciBuZXh0IGl0ZXJhdGlvbg0KICAgIG91dGNvbWVfZGF0YSA8LSBvdXRjb21lX2RhdGFbLCAuU0QsIC5TRGNvbHMgPSBrZWVwX3ZhcnNdDQogICAgcmZfZGF0YSA8LSBjb3B5KG91dGNvbWVfZGF0YSlbLCBteV9pZCA6PSBOVUxMXQ0KICAgIHJmX2RhdGFbLCBjb252ZXJzaW9uIDo9IGFzLmZhY3Rvcihjb252ZXJzaW9uKV0NCn0NCg0KYGBgDQoNCmBgYHtyfQ0KI2tpbGwgbXkgaWQNCm91dGNvbWVfZGF0YSRteV9pZCA8LSBOVUxMDQpgYGANCg0KDQoNCmBgYHtyLCB3YXJuaW5nPUZBTFNFLCBtZXNzYWdlPUZBTFNFfQ0KIyBSdW4gMTAwIHRlc3RzIHdpdGggbGluZWFyIG1vZGVsDQpjYXQoIlxuUnVubmluZyAxMDAgdGVzdCBpdGVyYXRpb25zIHdpdGggbGluZWFyIG1vZGVsLi4uXG4iKQ0KdGVzdF9hdWNzIDwtIGMoKQ0KdGVzdF9qX3N0YXRzIDwtIGMoKQ0KY29uZnVzaW9uX21hdHJpY2VzIDwtIGxpc3QoKQ0KcGVyZm9ybWFuY2VfbGlzdCA8LSBsaXN0KCkNCmFsbF90aHJlc2hvbGRzIDwtIGMoKQ0KDQojIENvbnZlcnQgZGF0YSBmb3IgbGluZWFyIG1vZGVsDQptb2RlbF9kYXRhIDwtIGNvcHkob3V0Y29tZV9kYXRhKQ0KbW9kZWxfZGF0YVssIGNvbnZlcnNpb24gOj0gYXMubnVtZXJpYyhhcy5jaGFyYWN0ZXIoY29udmVyc2lvbikpXQ0KDQojIFJ1biAxMDAgdGVzdHMgd2l0aCBsaW5lYXIgbW9kZWwNCnRlc3RfYXVjcyA8LSBjKCkNCnRlc3Rfal9zdGF0cyA8LSBjKCkNCmNvbmZ1c2lvbl9tYXRyaWNlcyA8LSBsaXN0KCkNCnBlcmZvcm1hbmNlX2xpc3QgPC0gbGlzdCgpDQphbGxfdGhyZXNob2xkcyA8LSBjKCkNCg0KIyBDb252ZXJ0IGRhdGEgZm9yIGxpbmVhciBtb2RlbA0KbW9kZWxfZGF0YSA8LSBjb3B5KG91dGNvbWVfZGF0YSkNCm1vZGVsX2RhdGFbLCBjb252ZXJzaW9uIDo9IGFzLm51bWVyaWMoYXMuY2hhcmFjdGVyKGNvbnZlcnNpb24pKV0NCg0KZm9yKGkgaW4gMToxMDApIHsNCiAgIyBDcmVhdGUgdGVzdCBzcGxpdA0KICBpZHggPC0gc2FtcGxlKDE6bnJvdyhtb2RlbF9kYXRhKSwgc2l6ZSA9IGZsb29yKDAuNyAqIG5yb3cobW9kZWxfZGF0YSkpKSAgIyBDaGFuZ2VkIHNhbXBsaW5nIGFwcHJvYWNoDQogIHRyYWluX2RhdGEgPC0gbW9kZWxfZGF0YVtpZHgsIF0NCiAgdGVzdF9kYXRhIDwtIG1vZGVsX2RhdGFbLWlkeCwgXQ0KICANCiAgIyBUcmFpbiBtb2RlbA0KICBtZGwgPC0gbG0oY29udmVyc2lvbiB+IC4sIGRhdGEgPSB0cmFpbl9kYXRhKQ0KICANCiAgIyBHZXQgcHJlZGljdGlvbnMgYW5kIGhhbmRsZSBwb3RlbnRpYWwgaXNzdWVzDQogIHAgPC0gcHJlZGljdChtZGwsIHRlc3RfZGF0YSkNCiAgDQogICMgQ2xlYW4gcHJlZGljdGlvbnMNCiAgcFtpcy5uYShwKV0gPC0gMCAgIyBIYW5kbGUgTkFzDQogIHBbaXMuaW5maW5pdGUocCldIDwtIDEgICMgSGFuZGxlIEluZg0KICBwW3AgPiAxXSA8LSAxICAjIEJvdW5kIHByZWRpY3Rpb25zDQogIHBbcCA8IDBdIDwtIDANCiAgDQogICMgQ29udmVydCBwcmVkaWN0aW9ucyBhbmQgYWN0dWFsIHZhbHVlcyB0byBudW1lcmljIHZlY3RvcnMNCiAgcHJlZF92YWx1ZXMgPC0gYXMubnVtZXJpYyhwKQ0KICBhY3R1YWxfdmFsdWVzIDwtIGFzLm51bWVyaWModGVzdF9kYXRhJGNvbnZlcnNpb24pDQogIA0KICAjIENoZWNrIGZvciBhbnkgcmVtYWluaW5nIGlzc3Vlcw0KICBpZihhbnkoaXMubmEocHJlZF92YWx1ZXMpKSB8fCBhbnkoaXMuaW5maW5pdGUocHJlZF92YWx1ZXMpKSkgew0KICAgIGNhdCgiV2FybmluZzogSW52YWxpZCBwcmVkaWN0aW9ucyBpbiBpdGVyYXRpb24iLCBpLCAiXG4iKQ0KICAgIG5leHQNCiAgfQ0KICANCiAgIyBDcmVhdGUgUk9DUiBwcmVkaWN0aW9uIG9iamVjdCB3aXRoIGVycm9yIGhhbmRsaW5nDQogIHRyeUNhdGNoKHsNCiAgICBwcmVkIDwtIHByZWRpY3Rpb24ocHJlZF92YWx1ZXMsIGFjdHVhbF92YWx1ZXMpDQogICAgDQogICAgIyBDYWxjdWxhdGUgQVVDDQogICAgcGVyZl9hdWMgPC0gcGVyZm9ybWFuY2UocHJlZCwgImF1YyIpDQogICAgdGVzdF9hdWNzW2ldIDwtIHBlcmZfYXVjQHkudmFsdWVzW1sxXV0NCiAgICANCiAgICAjIENhbGN1bGF0ZSBST0MgY3VydmUNCiAgICBwZXJmIDwtIHBlcmZvcm1hbmNlKHByZWQsICJ0cHIiLCAiZnByIikNCiAgICBwZXJmb3JtYW5jZV9saXN0W1tpXV0gPC0gcGVyZg0KICAgIA0KICAgICMgRmluZCBvcHRpbWFsIHRocmVzaG9sZCB1c2luZyBZb3VkZW4ncyBKIHN0YXRpc3RpYw0KICAgIHRwciA8LSB1bmxpc3QocGVyZkB5LnZhbHVlcykNCiAgICBmcHIgPC0gdW5saXN0KHBlcmZAeC52YWx1ZXMpDQogICAgal9zdGF0cyA8LSB0cHIgLSBmcHINCiAgICBiZXN0X2pfaWR4IDwtIHdoaWNoLm1heChqX3N0YXRzKQ0KICAgIG9wdGltYWxfdGhyZXNob2xkIDwtIHVubGlzdChwZXJmQGFscGhhLnZhbHVlcylbYmVzdF9qX2lkeF0NCiAgICBhbGxfdGhyZXNob2xkc1tpXSA8LSBvcHRpbWFsX3RocmVzaG9sZA0KICAgIHRlc3Rfal9zdGF0c1tpXSA8LSBqX3N0YXRzW2Jlc3Rfal9pZHhdDQogICAgDQogICAgIyBDcmVhdGUgY29uZnVzaW9uIG1hdHJpeA0KICAgIHByZWRfY2xhc3MgPC0gaWZlbHNlKHByZWRfdmFsdWVzID49IG9wdGltYWxfdGhyZXNob2xkLCAxLCAwKQ0KICAgIGNtIDwtIHRhYmxlKGZhY3RvcihhY3R1YWxfdmFsdWVzLCBsZXZlbHM9YygxLDApKSwgDQogICAgICAgICAgICAgICBmYWN0b3IocHJlZF9jbGFzcywgbGV2ZWxzPWMoMSwwKSkpDQogICAgY29sbmFtZXMoY20pIDwtIGMoIlByZWQgMSIsICJQcmVkIDAiKQ0KICAgIHJvd25hbWVzKGNtKSA8LSBjKCJUcnVlIDEiLCAiVHJ1ZSAwIikNCiAgICBjb25mdXNpb25fbWF0cmljZXNbW2ldXSA8LSBjbQ0KICB9LCBlcnJvciA9IGZ1bmN0aW9uKGUpIHsNCiAgICBjYXQoIkVycm9yIGluIGl0ZXJhdGlvbiIsIGksICI6IiwgZSRtZXNzYWdlLCAiXG4iKQ0KICB9KQ0KfQ0KDQojIENhbGN1bGF0ZSBhdmVyYWdlIGNvbmZ1c2lvbiBtYXRyaXgNCmF2Z19jbSA8LSBSZWR1Y2UoJysnLCBjb25mdXNpb25fbWF0cmljZXMpIC8gbGVuZ3RoKGNvbmZ1c2lvbl9tYXRyaWNlcykNCg0KIyBQcmludCBmaW5hbCByZXN1bHRzDQpjYXQoIlxuVGVzdCBSZXN1bHRzIG92ZXIgMTAwIGl0ZXJhdGlvbnM6XG4iKQ0KY2F0KCJNZWFuIEFVQzoiLCBtZWFuKHRlc3RfYXVjcyksICJcbiIpDQpjYXQoIlNEIEFVQzoiLCBzZCh0ZXN0X2F1Y3MpLCAiXG4iKQ0KY2F0KCJNZWFuIFlvdWRlbidzIEo6IiwgbWVhbih0ZXN0X2pfc3RhdHMpLCAiXG4iKQ0KY2F0KCJTRCBZb3VkZW4ncyBKOiIsIHNkKHRlc3Rfal9zdGF0cyksICJcbiIpDQpjYXQoIk1lYW4gT3B0aW1hbCBUaHJlc2hvbGQ6IiwgbWVhbihhbGxfdGhyZXNob2xkcyksICJcbiIpDQpjYXQoIjk1JSBDSSBmb3IgQVVDOiIsIG1lYW4odGVzdF9hdWNzKSAtIDEuOTYgKiBzZCh0ZXN0X2F1Y3MpLCANCiAgICAidG8iLCBtZWFuKHRlc3RfYXVjcykgKyAxLjk2ICogc2QodGVzdF9hdWNzKSwgIlxuIikNCmNhdCgiXG5BdmVyYWdlIENvbmZ1c2lvbiBNYXRyaXg6XG4iKQ0KcHJpbnQoYXZnX2NtKQ0KDQojIFBsb3R0aW5nIEFVQyBkaXN0cmlidXRpb24gLSByZW1vdmVkIHR5cGU9Im8iIHRvIG5vdCBjb25uZWN0IGRvdHMNCnBsb3QodGVzdF9hdWNzLCBjb2w9InJlZCIsIHBjaD0yMCwNCiAgICAgbWFpbj0iQVVDIFRlc3QgRGlzdHJpYnV0aW9uIiwNCiAgICAgeGxhYj0iSXRlcmF0aW9uIiwgeWxhYj0iQVVDIikNCmFibGluZShoPW1lYW4odGVzdF9hdWNzKSwgY29sPSJibHVlIiwgbHdkPTIsIGx0eT0yKQ0KYWJsaW5lKGg9bWVhbih0ZXN0X2F1Y3MpIC0gMS45NiAqIHNkKHRlc3RfYXVjcyksIGNvbD0iZ3JlZW4iLCBsd2Q9MiwgbHR5PTMpDQphYmxpbmUoaD1tZWFuKHRlc3RfYXVjcykgKyAxLjk2ICogc2QodGVzdF9hdWNzKSwgY29sPSJncmVlbiIsIGx3ZD0yLCBsdHk9MykNCmxlZ2VuZCgiYm90dG9tcmlnaHQiLCANCiAgICAgICBsZWdlbmQ9YygiQVVDIFZhbHVlcyIsICJNZWFuIiwgIjk1JSBDSSBCb3VuZHMiKSwNCiAgICAgICBjb2w9YygicmVkIiwgImJsdWUiLCAiZ3JlZW4iKSwNCiAgICAgICBsdHk9YyhOQSwgMiwgMyksDQogICAgICAgcGNoPWMoMjAsIE5BLCBOQSkpDQoNCiMgUGxvdCBST0MgY3VydmUgd2l0aCBjb25maWRlbmNlIGludGVydmFscw0Kc3VwcHJlc3NXYXJuaW5ncyh7DQogIHBsb3QoMDoxMDAvMTAwLCAwOjEwMC8xMDAsIHR5cGU9ImwiLCBsdHk9MiwgDQogICAgICAgeGxhYj0iRmFsc2UgUG9zaXRpdmUgUmF0ZSIsIHlsYWI9IlRydWUgUG9zaXRpdmUgUmF0ZSIsDQogICAgICAgbWFpbj0iUk9DIEN1cnZlIC0gTGluZWFyIE1vZGVsIikNCiAgDQogICMgQ2FsY3VsYXRlIGF2ZXJhZ2UgUk9DIGN1cnZlIHdpdGggY29uZmlkZW5jZSBpbnRlcnZhbHMNCiAgZnByX2dyaWQgPC0gc2VxKDAsIDEsIGxlbmd0aC5vdXQgPSAxMDApDQogIHRwcl9tYXRyaXggPC0gbWF0cml4KE5BLCBucm93ID0gbGVuZ3RoKHBlcmZvcm1hbmNlX2xpc3QpLCBuY29sID0gbGVuZ3RoKGZwcl9ncmlkKSkNCiAgDQogIGZvcihpIGluIHNlcV9hbG9uZyhwZXJmb3JtYW5jZV9saXN0KSkgew0KICAgIGN1cnZlX2kgPC0gcGVyZm9ybWFuY2VfbGlzdFtbaV1dDQogICAgdHByX21hdHJpeFtpLF0gPC0gYXBwcm94KGN1cnZlX2lAeC52YWx1ZXNbWzFdXSwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VydmVfaUB5LnZhbHVlc1tbMV1dLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4b3V0ID0gZnByX2dyaWQpJHkNCiAgfQ0KICANCiAgbWVhbl90cHIgPC0gY29sTWVhbnModHByX21hdHJpeCwgbmEucm0gPSBUUlVFKQ0KICBsaW5lcyhmcHJfZ3JpZCwgbWVhbl90cHIsIGNvbD0icmVkIiwgbHdkPTIpDQogIA0KICAjIEFkZCBvcHRpbWFsIHRocmVzaG9sZCBwb2ludA0KICBvcHRfcG9pbnRfaWR4IDwtIHdoaWNoLm1pbihhYnMoZnByX2dyaWQgLSBtZWFuKGFsbF90aHJlc2hvbGRzKSkpDQogIHBvaW50cyhmcHJfZ3JpZFtvcHRfcG9pbnRfaWR4XSwgbWVhbl90cHJbb3B0X3BvaW50X2lkeF0sIA0KICAgICAgICAgY29sPSJibHVlIiwgcGNoPTE5LCBjZXg9MS41KQ0KICANCiAgIyBBZGQgY29uZmlkZW5jZSBpbnRlcnZhbA0KICBjaV9sb3dlciA8LSBhcHBseSh0cHJfbWF0cml4LCAyLCBmdW5jdGlvbih4KSBxdWFudGlsZSh4LCAwLjAyNSwgbmEucm09VFJVRSkpDQogIGNpX3VwcGVyIDwtIGFwcGx5KHRwcl9tYXRyaXgsIDIsIGZ1bmN0aW9uKHgpIHF1YW50aWxlKHgsIDAuOTc1LCBuYS5ybT1UUlVFKSkNCiAgbGluZXMoZnByX2dyaWQsIGNpX2xvd2VyLCBjb2w9ImdyYXkiLCBsdHk9MikNCiAgbGluZXMoZnByX2dyaWQsIGNpX3VwcGVyLCBjb2w9ImdyYXkiLCBsdHk9MikNCiAgDQogICMgQWRkIGxlZ2VuZA0KICBsZWdlbmQoImJvdHRvbXJpZ2h0IiwgDQogICAgICAgICBsZWdlbmQ9YygiUmFuZG9tIiwgIkF2ZXJhZ2UgUk9DIiwgIjk1JSBDSSIsICJPcHRpbWFsIFRocmVzaG9sZCIpLA0KICAgICAgICAgY29sPWMoImJsYWNrIiwgInJlZCIsICJncmF5IiwgImJsdWUiKSwgDQogICAgICAgICBsdHk9YygyLDEsMixOQSksIA0KICAgICAgICAgcGNoPWMoTkEsTkEsTkEsMTkpLA0KICAgICAgICAgbHdkPWMoMSwyLDEsTkEpKQ0KfSkNCmBgYA0KDQoNCg0KDQpgYGB7ciwgd2FybmluZz1GQUxTRSwgbWVzc2FnZT1GQUxTRX0gICAgICAgICAgICAgICAgICAgICAgICANCiMgTG9hZCByZXF1aXJlZCBsaWJyYXJpZXMNCmxpYnJhcnkoeGdib29zdCkNCmxpYnJhcnkoUk9DUikNCmxpYnJhcnkocGFyYWxsZWwpDQoNCiMgUHJlcGFyZSB0aGUgWEdCb29zdCBtYXRyaWNlcw0KeHMgPC0gbW9kZWwubWF0cml4KH4gLiAtIDEgLSBjb252ZXJzaW9uLCBkYXRhID0gb3V0Y29tZV9kYXRhKQ0KeSA8LSBhcy5udW1lcmljKGFzLmNoYXJhY3RlcihvdXRjb21lX2RhdGEkY29udmVyc2lvbikpDQoNCiMgQ3JlYXRlIHBhcmFtZXRlciBncmlkDQpncmlkIDwtIGV4cGFuZC5ncmlkKA0KICBldGEgPSBzZXEoMC4wMDEsIDAuMDMsIGJ5ID0gMC4wMSksDQogIG1heF9kZXB0aCA9IHNlcSg1LCA1LCBieSA9IDIpLA0KICBtaW5fY2hpbGRfd2VpZ2h0ID0gc2VxKDEsIDEsIGJ5ID0gMSksICAgICAgICANCiAgc3Vic2FtcGxlID0gc2VxKDEsIDEsIGJ5ID0gMC4yKSwNCiAgY29sc2FtcGxlX2J5dHJlZSA9IHNlcSgxLCAxLCBieSA9IDAuMiksDQogIGxhbWJkYSA9IHNlcSgxLCAxLCBieSA9IDEpLCAgICAgICAgICAgICAgICANCiAgYWxwaGEgPSBzZXEoMCwgMCwgYnkgPSAxKSwgICAgICAgICAgICAgICAgICANCiAgZ2FtbWEgPSBzZXEoMCwgMCwgYnkgPSAwLjEpLCAgICAgICAgICAgICAgIA0KICBucm91bmRzID0gc2VxKDEwMCwgMjUwLCBieSA9IDUwKQ0KKQ0KIyBTYW1wbGUgZ3JpZCBwb2ludHMNCmNvbmZfbGV2IDwtIC45NQ0KbnVtX21heCA8LSA1DQpuIDwtIGNlaWxpbmcobG9nKDEtY29uZl9sZXYpL2xvZygxLW51bV9tYXgvbnJvdyhncmlkKSkpDQppbmQgPC0gc2FtcGxlKG5yb3coZ3JpZCksIG4sIHJlcGxhY2UgPSBGQUxTRSkNCnJncmlkIDwtIGdyaWRbaW5kLCBdDQoNCiMgU2V0IHVwIHBhcmFsbGVsIHByb2Nlc3NpbmcNCm5jIDwtIGRldGVjdENvcmVzKCkgLSAxDQoNCiMgVmFsaWRhdGlvbiBwaGFzZQ0KY2F0KCJcblBoYXNlIDE6IFZhbGlkYXRpb24gUGhhc2VcbiIpDQpuX3ZhbGlkYXRpb25zIDwtIDMNCnZhbGlkYXRpb25fcmVzdWx0cyA8LSBtYXRyaXgobnJvdyA9IG5yb3cocmdyaWQpLCBuY29sID0gbl92YWxpZGF0aW9ucykNCnZhbGlkYXRpb25fal9zdGF0cyA8LSBtYXRyaXgobnJvdyA9IG5yb3cocmdyaWQpLCBuY29sID0gbl92YWxpZGF0aW9ucykNCg0KZm9yIChqIGluIDE6bnJvdyhyZ3JpZCkpIHsNCiAjIGNhdCgiXG5UZXN0aW5nIHBhcmFtZXRlciBzZXQiLCBqLCAib2YiLCBucm93KHJncmlkKSwgIlxuIikNCiAgI2NhdCgiZXRhID0iLCByZ3JpZFtqLCAiZXRhIl0sICIsIG5yb3VuZHMgPSIsIHJncmlkW2osICJucm91bmRzIl0sICJcbiIpDQogIA0KICBmb3IgKGkgaW4gMTpuX3ZhbGlkYXRpb25zKSB7DQogICAgIyBDcmVhdGUgdmFsaWRhdGlvbiBzcGxpdA0KICAgIGlkeCA8LSB1bmlxdWUoc2FtcGxlKG5yb3coeHMpLCBucm93KHhzKSwgVCkpDQogICAgdHJhaW5feCA8LSB4c1tpZHgsIF0NCiAgICB0cmFpbl95IDwtIHlbaWR4XQ0KICAgIHZhbF94IDwtIHhzWy1pZHgsIF0NCiAgICB2YWxfeSA8LSB5Wy1pZHhdDQogICAgDQogICAgcHJtIDwtIGxpc3QoDQogICAgICBib29zdGVyID0gImdidHJlZSIsDQogICAgICBvYmplY3RpdmUgPSAiYmluYXJ5OmxvZ2lzdGljIiwNCiAgICAgIG1heF9kZXB0aCA9IHJncmlkW2osICJtYXhfZGVwdGgiXSwNCiAgICAgIGV0YSA9IHJncmlkW2osICJldGEiXSwNCiAgICAgIHN1YnNhbXBsZSA9IHJncmlkW2osICJzdWJzYW1wbGUiXSwNCiAgICAgIGNvbHNhbXBsZV9ieXRyZWUgPSByZ3JpZFtqLCAiY29sc2FtcGxlX2J5dHJlZSJdLA0KICAgICAgZ2FtbWEgPSByZ3JpZFtqLCAiZ2FtbWEiXSwNCiAgICAgIG1pbl9jaGlsZF93ZWlnaHQgPSByZ3JpZFtqLCAibWluX2NoaWxkX3dlaWdodCJdLA0KICAgICAgYWxwaGEgPSByZ3JpZFtqLCAiYWxwaGEiXSwNCiAgICAgIGxhbWJkYSA9IHJncmlkW2osICJsYW1iZGEiXSwNCiAgICAgIG50aHJlYWQgPSBuYw0KICAgICkNCiAgICANCiAgICBkbV90cmFpbiA8LSB4Z2IuRE1hdHJpeChkYXRhID0gdHJhaW5feCwgbGFiZWwgPSB0cmFpbl95KQ0KICAgIG1kbCA8LSB4Z2IudHJhaW4oDQogICAgICBwYXJhbXMgPSBwcm0sDQogICAgICBkYXRhID0gZG1fdHJhaW4sDQogICAgICBucm91bmRzID0gcmdyaWRbaiwgIm5yb3VuZHMiXSwNCiAgICAgIHZlcmJvc2UgPSBGQUxTRQ0KICAgICkNCiAgICANCiAgICAjIEdldCBwcmVkaWN0aW9ucyBhbmQgUk9DIG1ldHJpY3MNCiAgICBwIDwtIHByZWRpY3QobWRsLCB4Z2IuRE1hdHJpeChkYXRhID0gdmFsX3gpKQ0KICAgIHByZWQgPC0gcHJlZGljdGlvbihwLCB2YWxfeSkNCiAgICANCiAgICAjIENhbGN1bGF0ZSBBVUMNCiAgICB2YWxpZGF0aW9uX3Jlc3VsdHNbaiwgaV0gPC0gcGVyZm9ybWFuY2UocHJlZCwgImF1YyIpQHkudmFsdWVzW1sxXV0NCiAgICANCiAgICAjIENhbGN1bGF0ZSBZb3VkZW4ncyBKIFN0YXRpc3RpYw0KICAgIHJvYyA8LSBwZXJmb3JtYW5jZShwcmVkLCAidHByIiwgImZwciIpDQogICAgdHByIDwtIHVubGlzdChyb2NAeS52YWx1ZXMpDQogICAgZnByIDwtIHVubGlzdChyb2NAeC52YWx1ZXMpDQogICAgal9zdGF0cyA8LSB0cHIgLSBmcHINCiAgICB2YWxpZGF0aW9uX2pfc3RhdHNbaiwgaV0gPC0gbWF4KGpfc3RhdHMpDQogIH0NCiAgDQogICNjYXQoIk1lYW4gQVVDOiIsIG1lYW4odmFsaWRhdGlvbl9yZXN1bHRzW2osXSksICJcbiIpDQogICNjYXQoIlNEIEFVQzoiLCBzZCh2YWxpZGF0aW9uX3Jlc3VsdHNbaixdKSwgIlxuIikNCiAgI2NhdCgiTWVhbiBKIHN0YXRpc3RpYzoiLCBtZWFuKHZhbGlkYXRpb25fal9zdGF0c1tqLF0pLCAiXG4iKQ0KfQ0KDQojIFNlbGVjdCBiZXN0IHBhcmFtZXRlcnMgYmFzZWQgb24gdmFsaWRhdGlvbiBBVUMNCmJlc3RfcGFyYW1zX2lkeCA8LSB3aGljaC5tYXgocm93TWVhbnModmFsaWRhdGlvbl9yZXN1bHRzKSkNCmJlc3RfcGFyYW1zIDwtIHJncmlkW2Jlc3RfcGFyYW1zX2lkeCxdDQpjYXQoIlxuQmVzdCBwYXJhbWV0ZXJzOlxuIikNCnByaW50KGJlc3RfcGFyYW1zKQ0KDQojIFJ1biAxMDAgdGVzdHMgd2l0aCBiZXN0IHBhcmFtZXRlcnMNCmNhdCgiXG5SdW5uaW5nIDEwMCB0ZXN0IGl0ZXJhdGlvbnMgd2l0aCBiZXN0IHBhcmFtZXRlcnMuLi5cbiIpDQp0ZXN0X2F1Y3MgPC0gYygpDQp0ZXN0X2pfc3RhdHMgPC0gYygpDQpjb25mdXNpb25fbWF0cmljZXMgPC0gbGlzdCgpDQpwZXJmb3JtYW5jZV9saXN0IDwtIGxpc3QoKQ0KYWxsX3RocmVzaG9sZHMgPC0gYygpICAgICAgICAgICAgICAgICAgICAgICAgICAgICANCg0KIyBUcmFpbiBmaW5hbCBtb2RlbCB3aXRoIGJlc3QgcGFyYW1ldGVycw0KYmVzdF9wYXJhbXNfbGlzdCA8LSBhcy5saXN0KGJlc3RfcGFyYW1zWy13aGljaChuYW1lcyhiZXN0X3BhcmFtcykgPT0gIm5yb3VuZHMiKV0pDQpiZXN0X3BhcmFtc19saXN0JGJvb3N0ZXIgPC0gImdidHJlZSINCmJlc3RfcGFyYW1zX2xpc3Qkb2JqZWN0aXZlIDwtICJiaW5hcnk6bG9naXN0aWMiDQpiZXN0X3BhcmFtc19saXN0JG50aHJlYWQgPC0gbmMNCg0KZm9yKGkgaW4gMTo1MCkgew0KICAjY2F0KCJcbkl0ZXJhdGlvbiIsIGksICJvZiAxMDBcbiIpICAgICAgIA0KICAjIENyZWF0ZSB0ZXN0IHNwbGl0DQogIGlkeCA8LSB1bmlxdWUoc2FtcGxlKG5yb3coeHMpLCBucm93KHhzKSwgVCkpDQogIHRyYWluX3ggPC0geHNbaWR4LCBdDQogIHRyYWluX3kgPC0geVtpZHhdDQogIHRlc3RfeCA8LSB4c1staWR4LCBdDQogIHRlc3RfeSA8LSB5Wy1pZHhdDQogIA0KICAjIFRyYWluIG1vZGVsDQogIGRtX3RyYWluIDwtIHhnYi5ETWF0cml4KGRhdGEgPSB0cmFpbl94LCBsYWJlbCA9IHRyYWluX3kpDQogIG1kbCA8LSB4Z2IudHJhaW4oDQogICAgcGFyYW1zID0gYmVzdF9wYXJhbXNfbGlzdCwNCiAgICBkYXRhID0gZG1fdHJhaW4sDQogICAgbnJvdW5kcyA9IGJlc3RfcGFyYW1zW1sibnJvdW5kcyJdXSwNCiAgICB2ZXJib3NlID0gRkFMU0UNCiAgKQ0KICANCiAgIyBHZXQgcHJlZGljdGlvbnMNCiAgcCA8LSBwcmVkaWN0KG1kbCwgeGdiLkRNYXRyaXgoZGF0YSA9IHRlc3RfeCkpDQogIHByZWQgPC0gcHJlZGljdGlvbihwLCB0ZXN0X3kpDQogIA0KICAjIENhbGN1bGF0ZSBBVUMNCiAgdGVzdF9hdWNzW2ldIDwtIHBlcmZvcm1hbmNlKHByZWQsICJhdWMiKUB5LnZhbHVlc1tbMV1dDQogIA0KICAjIENhbGN1bGF0ZSBST0MgY3VydmUgYW5kIHN0b3JlDQogIHBlcmYgPC0gcGVyZm9ybWFuY2UocHJlZCwgInRwciIsICJmcHIiKQ0KICBwZXJmb3JtYW5jZV9saXN0W1tpXV0gPC0gcGVyZg0KICANCiAgIyBGaW5kIG9wdGltYWwgdGhyZXNob2xkIHVzaW5nIFlvdWRlbidzIEogc3RhdGlzdGljDQogIHRwciA8LSB1bmxpc3QocGVyZkB5LnZhbHVlcykNCiAgZnByIDwtIHVubGlzdChwZXJmQHgudmFsdWVzKQ0KICBqX3N0YXRzIDwtIHRwciAtIGZwcg0KICBiZXN0X2pfaWR4IDwtIHdoaWNoLm1heChqX3N0YXRzKQ0KICBvcHRpbWFsX3RocmVzaG9sZCA8LSB1bmxpc3QocGVyZkBhbHBoYS52YWx1ZXMpW2Jlc3Rfal9pZHhdDQogIGFsbF90aHJlc2hvbGRzW2ldIDwtIG9wdGltYWxfdGhyZXNob2xkDQogIHRlc3Rfal9zdGF0c1tpXSA8LSBqX3N0YXRzW2Jlc3Rfal9pZHhdDQogIA0KICAjIENyZWF0ZSBjb25mdXNpb24gbWF0cml4IHdpdGggb3B0aW1hbCB0aHJlc2hvbGQgKDEtMCBvcmRlciB3aXRoIFRQIGluIHRvcCBsZWZ0KQ0KICBwcmVkX2NsYXNzIDwtIGlmZWxzZShwID49IG9wdGltYWxfdGhyZXNob2xkLCAxLCAwKQ0KICBjbSA8LSB0YWJsZShmYWN0b3IodGVzdF95LCBsZXZlbHM9YygxLDApKSwgDQogICAgICAgICAgICAgZmFjdG9yKHByZWRfY2xhc3MsIGxldmVscz1jKDEsMCkpKQ0KICBjb2xuYW1lcyhjbSkgPC0gYygiUHJlZCAxIiwgIlByZWQgMCIpDQogIHJvd25hbWVzKGNtKSA8LSBjKCJUcnVlIDEiLCAiVHJ1ZSAwIikNCiAgY29uZnVzaW9uX21hdHJpY2VzW1tpXV0gPC0gY20NCn0NCg0KIyBDYWxjdWxhdGUgYXZlcmFnZSBjb25mdXNpb24gbWF0cml4DQphdmdfY20gPC0gUmVkdWNlKCcrJywgY29uZnVzaW9uX21hdHJpY2VzKSAvIGxlbmd0aChjb25mdXNpb25fbWF0cmljZXMpDQoNCiMgUHJpbnQgZmluYWwgcmVzdWx0cw0KY2F0KCJcblRlc3QgUmVzdWx0cyBvdmVyIDEwMCBpdGVyYXRpb25zOlxuIikNCmNhdCgiTWVhbiBBVUM6IiwgbWVhbih0ZXN0X2F1Y3MpLCAiXG4iKQ0KY2F0KCJTRCBBVUM6Iiwgc2QodGVzdF9hdWNzKSwgIlxuIikNCmNhdCgiTWVhbiBZb3VkZW4ncyBKOiIsIG1lYW4odGVzdF9qX3N0YXRzKSwgIlxuIikNCmNhdCgiU0QgWW91ZGVuJ3MgSjoiLCBzZCh0ZXN0X2pfc3RhdHMpLCAiXG4iKQ0KY2F0KCJNZWFuIE9wdGltYWwgVGhyZXNob2xkOiIsIG1lYW4oYWxsX3RocmVzaG9sZHMpLCAiXG4iKQ0KY2F0KCI5NSUgQ0kgZm9yIEFVQzoiLCBtZWFuKHRlc3RfYXVjcykgLSAxLjk2ICogc2QodGVzdF9hdWNzKSwgDQogICAgInRvIiwgbWVhbih0ZXN0X2F1Y3MpICsgMS45NiAqIHNkKHRlc3RfYXVjcyksICJcbiIpDQpjYXQoIlxuQXZlcmFnZSBDb25mdXNpb24gTWF0cml4OlxuIikNCnByaW50KGF2Z19jbSkNCg0KIyBQbG90dGluZyBBVUMgZGlzdHJpYnV0aW9uIC0gcmVtb3ZlZCB0eXBlPSJvIiB0byBub3QgY29ubmVjdCBkb3RzDQpwbG90KHRlc3RfYXVjcywgY29sPSJyZWQiLCBwY2g9MjAsDQogICAgIG1haW49IkFVQyBUZXN0IERpc3RyaWJ1dGlvbiIsDQogICAgIHhsYWI9Ikl0ZXJhdGlvbiIsIHlsYWI9IkFVQyIpDQphYmxpbmUoaD1tZWFuKHRlc3RfYXVjcyksIGNvbD0iYmx1ZSIsIGx3ZD0yLCBsdHk9MikNCmFibGluZShoPW1lYW4odGVzdF9hdWNzKSAtIDEuOTYgKiBzZCh0ZXN0X2F1Y3MpLCBjb2w9ImdyZWVuIiwgbHdkPTIsIGx0eT0zKQ0KYWJsaW5lKGg9bWVhbih0ZXN0X2F1Y3MpICsgMS45NiAqIHNkKHRlc3RfYXVjcyksIGNvbD0iZ3JlZW4iLCBsd2Q9MiwgbHR5PTMpDQpsZWdlbmQoImJvdHRvbXJpZ2h0IiwgDQogICAgICAgbGVnZW5kPWMoIkFVQyBWYWx1ZXMiLCAiTWVhbiIsICI5NSUgQ0kgQm91bmRzIiksDQogICAgICAgY29sPWMoInJlZCIsICJibHVlIiwgImdyZWVuIiksDQogICAgICAgbHR5PWMoTkEsIDIsIDMpLA0KICAgICAgIHBjaD1jKDIwLCBOQSwgTkEpKQ0KDQoNCiMgUGxvdCBST0MgY3VydmUgd2l0aCBjb25maWRlbmNlIGludGVydmFscw0KcGxvdCgwOjEwMC8xMDAsIDA6MTAwLzEwMCwgdHlwZT0ibCIsIGx0eT0yLCANCiAgICAgeGxhYj0iRmFsc2UgUG9zaXRpdmUgUmF0ZSIsIHlsYWI9IlRydWUgUG9zaXRpdmUgUmF0ZSIsDQogICAgIG1haW49IlJPQyBDdXJ2ZSIpDQoNCiMgQ2FsY3VsYXRlIGF2ZXJhZ2UgUk9DIGN1cnZlIHdpdGggY29uZmlkZW5jZSBpbnRlcnZhbHMNCmZwcl9ncmlkIDwtIHNlcSgwLCAxLCBsZW5ndGgub3V0ID0gMTAwKQ0KdHByX21hdHJpeCA8LSBtYXRyaXgoTkEsIG5yb3cgPSBsZW5ndGgocGVyZm9ybWFuY2VfbGlzdCksIG5jb2wgPSBsZW5ndGgoZnByX2dyaWQpKQ0KDQpmb3IoaSBpbiBzZXFfYWxvbmcocGVyZm9ybWFuY2VfbGlzdCkpIHsNCiAgY3VydmVfaSA8LSBwZXJmb3JtYW5jZV9saXN0W1tpXV0NCiAgdHByX21hdHJpeFtpLF0gPC0gYXBwcm94KGN1cnZlX2lAeC52YWx1ZXNbWzFdXSwgDQogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnZlX2lAeS52YWx1ZXNbWzFdXSwgDQogICAgICAgICAgICAgICAgICAgICAgICAgIHhvdXQgPSBmcHJfZ3JpZCkkeQ0KfQ0KDQptZWFuX3RwciA8LSBjb2xNZWFucyh0cHJfbWF0cml4LCBuYS5ybSA9IFRSVUUpDQpsaW5lcyhmcHJfZ3JpZCwgbWVhbl90cHIsIGNvbD0icmVkIiwgbHdkPTIpDQoNCiMgQWRkIG9wdGltYWwgdGhyZXNob2xkIHBvaW50DQpvcHRfcG9pbnRfaWR4IDwtIHdoaWNoLm1pbihhYnMoZnByX2dyaWQgLSBtZWFuKGFsbF90aHJlc2hvbGRzKSkpDQpwb2ludHMoZnByX2dyaWRbb3B0X3BvaW50X2lkeF0sIG1lYW5fdHByW29wdF9wb2ludF9pZHhdLCANCiAgICAgICBjb2w9ImJsdWUiLCBwY2g9MTksIGNleD0xLjUpDQoNCiMgQWRkIGNvbmZpZGVuY2UgaW50ZXJ2YWwNCmNpX2xvd2VyIDwtIGFwcGx5KHRwcl9tYXRyaXgsIDIsIGZ1bmN0aW9uKHgpIHF1YW50aWxlKHgsIDAuMDI1LCBuYS5ybT1UUlVFKSkNCmNpX3VwcGVyIDwtIGFwcGx5KHRwcl9tYXRyaXgsIDIsIGZ1bmN0aW9uKHgpIHF1YW50aWxlKHgsIDAuOTc1LCBuYS5ybT1UUlVFKSkNCmxpbmVzKGZwcl9ncmlkLCBjaV9sb3dlciwgY29sPSJncmF5IiwgbHR5PTIpDQpsaW5lcyhmcHJfZ3JpZCwgY2lfdXBwZXIsIGNvbD0iZ3JheSIsIGx0eT0yKQ0KDQojIEFkZCBsZWdlbmQNCmxlZ2VuZCgiYm90dG9tcmlnaHQiLCANCiAgICAgICBsZWdlbmQ9YygiUmFuZG9tIiwgIkF2ZXJhZ2UgUk9DIiwgIjk1JSBDSSIsICJPcHRpbWFsIFRocmVzaG9sZCIpLA0KICAgICAgIGNvbD1jKCJibGFjayIsICJyZWQiLCAiZ3JheSIsICJibHVlIiksIA0KICAgICAgIGx0eT1jKDIsMSwyLE5BKSwgDQogICAgICAgcGNoPWMoTkEsTkEsTkEsMTkpLA0KICAgICAgIGx3ZD1jKDEsMiwxLE5BKSkNCmBgYA0KDQoNCmBgYHtyLCB3YXJuaW5nPUZBTFNFLCBtZXNzYWdlPUZBTFNFfQ0KIyBMb2FkIHJlcXVpcmVkIGxpYnJhcmllcw0KbGlicmFyeShkYXRhLnRhYmxlKQ0KbGlicmFyeSh4Z2Jvb3N0KQ0KbGlicmFyeShST0NSKQ0KbGlicmFyeShwYXJhbGxlbCkNCg0KIyBQcmVwYXJlIHRoZSBYR0Jvb3N0IG1hdHJpY2VzDQp4cyA8LSBtb2RlbC5tYXRyaXgofiAuIC0gMSAtIGNvbnZlcnNpb24sIGRhdGEgPSBvdXRjb21lX2RhdGEpDQp5IDwtIGFzLm51bWVyaWMoYXMuY2hhcmFjdGVyKG91dGNvbWVfZGF0YSRjb252ZXJzaW9uKSkNCg0KIyBDcmVhdGUgcGFyYW1ldGVyIGdyaWQgLSBvbmx5IHR1bmUgZXRhIGFuZCBucm91bmRzDQpncmlkIDwtIGV4cGFuZC5ncmlkKA0KICBldGEgPSBzZXEoMC4wMDEsIDAuMDMsIGJ5ID0gMC4wMSksDQogIG5yb3VuZHMgPSBzZXEoNTAsIDUwMCwgYnkgPSA1MCkNCikNCg0KIyBTYW1wbGUgZ3JpZCBwb2ludHMNCmNvbmZfbGV2IDwtIC45NQ0KbnVtX21heCA8LSA1DQpuIDwtIGNlaWxpbmcobG9nKDEtY29uZl9sZXYpL2xvZygxLW51bV9tYXgvbnJvdyhncmlkKSkpDQppbmQgPC0gc2FtcGxlKG5yb3coZ3JpZCksIG4sIHJlcGxhY2UgPSBGQUxTRSkNCnJncmlkIDwtIGdyaWRbaW5kLCBdDQoNCiMgU2V0IHVwIHBhcmFsbGVsIHByb2Nlc3NpbmcNCm5jIDwtIGRldGVjdENvcmVzKCkgLSAxDQoNCiMgVmFsaWRhdGlvbiBwaGFzZQ0KY2F0KCJcblBoYXNlIDE6IFZhbGlkYXRpb24gUGhhc2VcbiIpDQpuX3ZhbGlkYXRpb25zIDwtIDMNCnZhbGlkYXRpb25fcmVzdWx0cyA8LSBtYXRyaXgobnJvdyA9IG5yb3cocmdyaWQpLCBuY29sID0gbl92YWxpZGF0aW9ucykNCnZhbGlkYXRpb25fal9zdGF0cyA8LSBtYXRyaXgobnJvdyA9IG5yb3cocmdyaWQpLCBuY29sID0gbl92YWxpZGF0aW9ucykNCg0KZm9yIChqIGluIDE6bnJvdyhyZ3JpZCkpIHsNCiAgI2NhdCgiXG5UZXN0aW5nIHBhcmFtZXRlciBzZXQiLCBqLCAib2YiLCBucm93KHJncmlkKSwgIlxuIikNCiAgI2NhdCgiZXRhID0iLCByZ3JpZFtqLCAiZXRhIl0sICIsIG5yb3VuZHMgPSIsIHJncmlkW2osICJucm91bmRzIl0sICJcbiIpDQogIA0KICBmb3IgKGkgaW4gMTpuX3ZhbGlkYXRpb25zKSB7DQogICAgIyBDcmVhdGUgdmFsaWRhdGlvbiBzcGxpdA0KICAgIGlkeCA8LSB1bmlxdWUoc2FtcGxlKG5yb3coeHMpLCBucm93KHhzKSwgVCkpDQogICAgdHJhaW5feCA8LSB4c1tpZHgsIF0NCiAgICB0cmFpbl95IDwtIHlbaWR4XQ0KICAgIHZhbF94IDwtIHhzWy1pZHgsIF0NCiAgICB2YWxfeSA8LSB5Wy1pZHhdDQogICAgDQogICAgcHJtIDwtIGxpc3QoDQogICAgICBib29zdGVyID0gImdibGluZWFyIiwNCiAgICAgIG9iamVjdGl2ZSA9ICJiaW5hcnk6bG9naXN0aWMiLA0KICAgICAgZXRhID0gcmdyaWRbaiwgImV0YSJdLA0KICAgICAgbnRocmVhZCA9IG5jDQogICAgKQ0KICAgIA0KICAgIGRtX3RyYWluIDwtIHhnYi5ETWF0cml4KGRhdGEgPSB0cmFpbl94LCBsYWJlbCA9IHRyYWluX3kpDQogICAgbWRsIDwtIHhnYi50cmFpbigNCiAgICAgIHBhcmFtcyA9IHBybSwNCiAgICAgIGRhdGEgPSBkbV90cmFpbiwNCiAgICAgIG5yb3VuZHMgPSByZ3JpZFtqLCAibnJvdW5kcyJdLA0KICAgICAgdmVyYm9zZSA9IEZBTFNFDQogICAgKQ0KICAgIA0KICAgICMgR2V0IHByZWRpY3Rpb25zIGFuZCBST0MgbWV0cmljcw0KICAgIHAgPC0gcHJlZGljdChtZGwsIHhnYi5ETWF0cml4KGRhdGEgPSB2YWxfeCkpDQogICAgcHJlZCA8LSBwcmVkaWN0aW9uKHAsIHZhbF95KQ0KICAgIA0KICAgICMgQ2FsY3VsYXRlIEFVQw0KICAgIHZhbGlkYXRpb25fcmVzdWx0c1tqLCBpXSA8LSBwZXJmb3JtYW5jZShwcmVkLCAiYXVjIilAeS52YWx1ZXNbWzFdXQ0KICAgIA0KICAgICMgQ2FsY3VsYXRlIFlvdWRlbidzIEogU3RhdGlzdGljDQogICAgcm9jIDwtIHBlcmZvcm1hbmNlKHByZWQsICJ0cHIiLCAiZnByIikNCiAgICB0cHIgPC0gdW5saXN0KHJvY0B5LnZhbHVlcykNCiAgICBmcHIgPC0gdW5saXN0KHJvY0B4LnZhbHVlcykNCiAgICBqX3N0YXRzIDwtIHRwciAtIGZwcg0KICAgIHZhbGlkYXRpb25fal9zdGF0c1tqLCBpXSA8LSBtYXgoal9zdGF0cykNCiAgfQ0KICANCiAgI2NhdCgiTWVhbiBBVUM6IiwgbWVhbih2YWxpZGF0aW9uX3Jlc3VsdHNbaixdKSwgIlxuIikNCiAgI2NhdCgiU0QgQVVDOiIsIHNkKHZhbGlkYXRpb25fcmVzdWx0c1tqLF0pLCAiXG4iKQ0KICAjY2F0KCJNZWFuIEogc3RhdGlzdGljOiIsIG1lYW4odmFsaWRhdGlvbl9qX3N0YXRzW2osXSksICJcbiIpDQp9DQoNCiMgU2VsZWN0IGJlc3QgcGFyYW1ldGVycyBiYXNlZCBvbiB2YWxpZGF0aW9uIEFVQw0KYmVzdF9wYXJhbXNfaWR4IDwtIHdoaWNoLm1heChyb3dNZWFucyh2YWxpZGF0aW9uX3Jlc3VsdHMpKQ0KYmVzdF9wYXJhbXMgPC0gcmdyaWRbYmVzdF9wYXJhbXNfaWR4LF0NCmNhdCgiXG5CZXN0IHBhcmFtZXRlcnM6XG4iKQ0KcHJpbnQoYmVzdF9wYXJhbXMpDQoNCiMgUnVuIFggdGVzdHMgd2l0aCBiZXN0IHBhcmFtZXRlcnMNCmNhdCgiXG5SdW5uaW5nIFggdGVzdCBpdGVyYXRpb25zIHdpdGggYmVzdCBwYXJhbWV0ZXJzLi4uXG4iKQ0KdGVzdF9hdWNzIDwtIGMoKQ0KdGVzdF9qX3N0YXRzIDwtIGMoKQ0KY29uZnVzaW9uX21hdHJpY2VzIDwtIGxpc3QoKQ0KcGVyZm9ybWFuY2VfbGlzdCA8LSBsaXN0KCkNCmFsbF90aHJlc2hvbGRzIDwtIGMoKQ0KDQojIFRyYWluIGZpbmFsIG1vZGVsIHdpdGggYmVzdCBwYXJhbWV0ZXJzDQpiZXN0X3BhcmFtc19saXN0IDwtIGFzLmxpc3QoYmVzdF9wYXJhbXNbLXdoaWNoKG5hbWVzKGJlc3RfcGFyYW1zKSA9PSAibnJvdW5kcyIpXSkNCmJlc3RfcGFyYW1zX2xpc3QkYm9vc3RlciA8LSAiZ2JsaW5lYXIiDQpiZXN0X3BhcmFtc19saXN0JG9iamVjdGl2ZSA8LSAiYmluYXJ5OmxvZ2lzdGljIg0KYmVzdF9wYXJhbXNfbGlzdCRudGhyZWFkIDwtIG5jDQoNCmZvcihpIGluIDE6NTApIHsNCiAgI2NhdCgiXG5JdGVyYXRpb24iLCBpLCAib2YgMTAwXG4iKSAgICAgICANCiAgIyBDcmVhdGUgdGVzdCBzcGxpdA0KICBpZHggPC0gdW5pcXVlKHNhbXBsZShucm93KHhzKSwgbnJvdyh4cyksIFQpKQ0KICB0cmFpbl94IDwtIHhzW2lkeCwgXQ0KICB0cmFpbl95IDwtIHlbaWR4XQ0KICB0ZXN0X3ggPC0geHNbLWlkeCwgXQ0KICB0ZXN0X3kgPC0geVstaWR4XQ0KICANCiAgIyBUcmFpbiBtb2RlbA0KICBkbV90cmFpbiA8LSB4Z2IuRE1hdHJpeChkYXRhID0gdHJhaW5feCwgbGFiZWwgPSB0cmFpbl95KQ0KICBtZGwgPC0geGdiLnRyYWluKA0KICAgIHBhcmFtcyA9IGJlc3RfcGFyYW1zX2xpc3QsDQogICAgZGF0YSA9IGRtX3RyYWluLA0KICAgIG5yb3VuZHMgPSBiZXN0X3BhcmFtc1tbIm5yb3VuZHMiXV0sDQogICAgdmVyYm9zZSA9IEZBTFNFDQogICkNCiAgDQogICMgR2V0IHByZWRpY3Rpb25zDQogIHAgPC0gcHJlZGljdChtZGwsIHhnYi5ETWF0cml4KGRhdGEgPSB0ZXN0X3gpKQ0KICBwcmVkIDwtIHByZWRpY3Rpb24ocCwgdGVzdF95KQ0KICANCiAgIyBDYWxjdWxhdGUgQVVDDQogIHRlc3RfYXVjc1tpXSA8LSBwZXJmb3JtYW5jZShwcmVkLCAiYXVjIilAeS52YWx1ZXNbWzFdXQ0KICANCiAgIyBDYWxjdWxhdGUgUk9DIGN1cnZlIGFuZCBzdG9yZQ0KICBwZXJmIDwtIHBlcmZvcm1hbmNlKHByZWQsICJ0cHIiLCAiZnByIikNCiAgcGVyZm9ybWFuY2VfbGlzdFtbaV1dIDwtIHBlcmYNCiAgDQogICMgRmluZCBvcHRpbWFsIHRocmVzaG9sZCB1c2luZyBZb3VkZW4ncyBKIHN0YXRpc3RpYw0KICB0cHIgPC0gdW5saXN0KHBlcmZAeS52YWx1ZXMpDQogIGZwciA8LSB1bmxpc3QocGVyZkB4LnZhbHVlcykNCiAgal9zdGF0cyA8LSB0cHIgLSBmcHINCiAgYmVzdF9qX2lkeCA8LSB3aGljaC5tYXgoal9zdGF0cykNCiAgb3B0aW1hbF90aHJlc2hvbGQgPC0gdW5saXN0KHBlcmZAYWxwaGEudmFsdWVzKVtiZXN0X2pfaWR4XQ0KICBhbGxfdGhyZXNob2xkc1tpXSA8LSBvcHRpbWFsX3RocmVzaG9sZA0KICB0ZXN0X2pfc3RhdHNbaV0gPC0gal9zdGF0c1tiZXN0X2pfaWR4XQ0KICANCiAgIyBDcmVhdGUgY29uZnVzaW9uIG1hdHJpeCB3aXRoIG9wdGltYWwgdGhyZXNob2xkICgxLTAgb3JkZXIgd2l0aCBUUCBpbiB0b3AgbGVmdCkNCiAgcHJlZF9jbGFzcyA8LSBpZmVsc2UocCA+PSBvcHRpbWFsX3RocmVzaG9sZCwgMSwgMCkNCiAgY20gPC0gdGFibGUoZmFjdG9yKHRlc3RfeSwgbGV2ZWxzPWMoMSwwKSksIA0KICAgICAgICAgICAgIGZhY3RvcihwcmVkX2NsYXNzLCBsZXZlbHM9YygxLDApKSkNCiAgY29sbmFtZXMoY20pIDwtIGMoIlByZWQgMSIsICJQcmVkIDAiKQ0KICByb3duYW1lcyhjbSkgPC0gYygiVHJ1ZSAxIiwgIlRydWUgMCIpDQogIGNvbmZ1c2lvbl9tYXRyaWNlc1tbaV1dIDwtIGNtDQp9DQoNCiMgQ2FsY3VsYXRlIGF2ZXJhZ2UgY29uZnVzaW9uIG1hdHJpeA0KYXZnX2NtIDwtIFJlZHVjZSgnKycsIGNvbmZ1c2lvbl9tYXRyaWNlcykgLyBsZW5ndGgoY29uZnVzaW9uX21hdHJpY2VzKQ0KDQojIFByaW50IGZpbmFsIHJlc3VsdHMNCmNhdCgiXG5UZXN0IFJlc3VsdHMgb3ZlciAxMDAgaXRlcmF0aW9uczpcbiIpDQpjYXQoIk1lYW4gQVVDOiIsIG1lYW4odGVzdF9hdWNzKSwgIlxuIikNCmNhdCgiU0QgQVVDOiIsIHNkKHRlc3RfYXVjcyksICJcbiIpDQpjYXQoIk1lYW4gWW91ZGVuJ3MgSjoiLCBtZWFuKHRlc3Rfal9zdGF0cyksICJcbiIpDQpjYXQoIlNEIFlvdWRlbidzIEo6Iiwgc2QodGVzdF9qX3N0YXRzKSwgIlxuIikNCmNhdCgiTWVhbiBPcHRpbWFsIFRocmVzaG9sZDoiLCBtZWFuKGFsbF90aHJlc2hvbGRzKSwgIlxuIikNCmNhdCgiOTUlIENJIGZvciBBVUM6IiwgbWVhbih0ZXN0X2F1Y3MpIC0gMS45NiAqIHNkKHRlc3RfYXVjcyksIA0KICAgICJ0byIsIG1lYW4odGVzdF9hdWNzKSArIDEuOTYgKiBzZCh0ZXN0X2F1Y3MpLCAiXG4iKQ0KY2F0KCJcbkF2ZXJhZ2UgQ29uZnVzaW9uIE1hdHJpeDpcbiIpDQpwcmludChhdmdfY20pDQoNCiMgUGxvdHRpbmcgQVVDIGRpc3RyaWJ1dGlvbiAtIHJlbW92ZWQgdHlwZT0ibyIgdG8gbm90IGNvbm5lY3QgZG90cw0KcGxvdCh0ZXN0X2F1Y3MsIGNvbD0icmVkIiwgcGNoPTIwLA0KICAgICBtYWluPSJBVUMgVGVzdCBEaXN0cmlidXRpb24iLA0KICAgICB4bGFiPSJJdGVyYXRpb24iLCB5bGFiPSJBVUMiKQ0KYWJsaW5lKGg9bWVhbih0ZXN0X2F1Y3MpLCBjb2w9ImJsdWUiLCBsd2Q9MiwgbHR5PTIpDQphYmxpbmUoaD1tZWFuKHRlc3RfYXVjcykgLSAxLjk2ICogc2QodGVzdF9hdWNzKSwgY29sPSJncmVlbiIsIGx3ZD0yLCBsdHk9MykNCmFibGluZShoPW1lYW4odGVzdF9hdWNzKSArIDEuOTYgKiBzZCh0ZXN0X2F1Y3MpLCBjb2w9ImdyZWVuIiwgbHdkPTIsIGx0eT0zKQ0KbGVnZW5kKCJib3R0b21yaWdodCIsIA0KICAgICAgIGxlZ2VuZD1jKCJBVUMgVmFsdWVzIiwgIk1lYW4iLCAiOTUlIENJIEJvdW5kcyIpLA0KICAgICAgIGNvbD1jKCJyZWQiLCAiYmx1ZSIsICJncmVlbiIpLA0KICAgICAgIGx0eT1jKE5BLCAyLCAzKSwNCiAgICAgICBwY2g9YygyMCwgTkEsIE5BKSkNCg0KDQojIFBsb3QgUk9DIGN1cnZlIHdpdGggY29uZmlkZW5jZSBpbnRlcnZhbHMNCnBsb3QoMDoxMDAvMTAwLCAwOjEwMC8xMDAsIHR5cGU9ImwiLCBsdHk9MiwgDQogICAgIHhsYWI9IkZhbHNlIFBvc2l0aXZlIFJhdGUiLCB5bGFiPSJUcnVlIFBvc2l0aXZlIFJhdGUiLA0KICAgICBtYWluPSJST0MgQ3VydmUiKQ0KDQojIENhbGN1bGF0ZSBhdmVyYWdlIFJPQyBjdXJ2ZSB3aXRoIGNvbmZpZGVuY2UgaW50ZXJ2YWxzDQpmcHJfZ3JpZCA8LSBzZXEoMCwgMSwgbGVuZ3RoLm91dCA9IDEwMCkNCnRwcl9tYXRyaXggPC0gbWF0cml4KE5BLCBucm93ID0gbGVuZ3RoKHBlcmZvcm1hbmNlX2xpc3QpLCBuY29sID0gbGVuZ3RoKGZwcl9ncmlkKSkNCg0KZm9yKGkgaW4gc2VxX2Fsb25nKHBlcmZvcm1hbmNlX2xpc3QpKSB7DQogIGN1cnZlX2kgPC0gcGVyZm9ybWFuY2VfbGlzdFtbaV1dDQogIHRwcl9tYXRyaXhbaSxdIDwtIGFwcHJveChjdXJ2ZV9pQHgudmFsdWVzW1sxXV0sIA0KICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJ2ZV9pQHkudmFsdWVzW1sxXV0sIA0KICAgICAgICAgICAgICAgICAgICAgICAgICB4b3V0ID0gZnByX2dyaWQpJHkNCn0NCg0KbWVhbl90cHIgPC0gY29sTWVhbnModHByX21hdHJpeCwgbmEucm0gPSBUUlVFKQ0KbGluZXMoZnByX2dyaWQsIG1lYW5fdHByLCBjb2w9InJlZCIsIGx3ZD0yKQ0KDQojIEFkZCBvcHRpbWFsIHRocmVzaG9sZCBwb2ludA0Kb3B0X3BvaW50X2lkeCA8LSB3aGljaC5taW4oYWJzKGZwcl9ncmlkIC0gbWVhbihhbGxfdGhyZXNob2xkcykpKQ0KcG9pbnRzKGZwcl9ncmlkW29wdF9wb2ludF9pZHhdLCBtZWFuX3RwcltvcHRfcG9pbnRfaWR4XSwgDQogICAgICAgY29sPSJibHVlIiwgcGNoPTE5LCBjZXg9MS41KQ0KDQojIEFkZCBjb25maWRlbmNlIGludGVydmFsDQpjaV9sb3dlciA8LSBhcHBseSh0cHJfbWF0cml4LCAyLCBmdW5jdGlvbih4KSBxdWFudGlsZSh4LCAwLjAyNSwgbmEucm09VFJVRSkpDQpjaV91cHBlciA8LSBhcHBseSh0cHJfbWF0cml4LCAyLCBmdW5jdGlvbih4KSBxdWFudGlsZSh4LCAwLjk3NSwgbmEucm09VFJVRSkpDQpsaW5lcyhmcHJfZ3JpZCwgY2lfbG93ZXIsIGNvbD0iZ3JheSIsIGx0eT0yKQ0KbGluZXMoZnByX2dyaWQsIGNpX3VwcGVyLCBjb2w9ImdyYXkiLCBsdHk9MikNCg0KIyBBZGQgbGVnZW5kDQpsZWdlbmQoImJvdHRvbXJpZ2h0IiwgDQogICAgICAgbGVnZW5kPWMoIlJhbmRvbSIsICJBdmVyYWdlIFJPQyIsICI5NSUgQ0kiLCAiT3B0aW1hbCBUaHJlc2hvbGQiKSwNCiAgICAgICBjb2w9YygiYmxhY2siLCAicmVkIiwgImdyYXkiLCAiYmx1ZSIpLCANCiAgICAgICBsdHk9YygyLDEsMixOQSksIA0KICAgICAgIHBjaD1jKE5BLE5BLE5BLDE5KSwNCiAgICAgICBsd2Q9YygxLDIsMSxOQSkpDQpgYGANCg0K</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("xgboost.Rmd");
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
