---
title: "attempt_ols"
output: html_document
date: "2025-02-08"
---


```{r}
library(data.table)   
select_data <- fread("predict_select_v2.csv.gz")

# Remove unwanted columns
select_data[, c("attendance_raw", "attendance_pct", "my_id") := NULL]
```

```{r}
# Existing code
select_data[, yardline_31_40 := NULL]
select_data[, Giff_Smith := NULL]
```



```{r}
# Load required packages
library(sandwich)
library(lmtest)

# OLS Model
ols_model <- lm(attempt ~ ., data = select_data)

# Get robust statistics for OLS
ols_robust <- coeftest(ols_model, vcov = vcovHC(ols_model, type = "HC0"))


# Function to format results nicely
format_results <- function(model_results, model_name) {
    cat(sprintf("\n%s Model Results (Robust Statistics)\n", model_name))
    cat(sprintf("%-30s %12s %12s %6s\n", "Variable", "Coefficient", "t-value", "Sig"))
    cat(paste(rep("-", 65), collapse = ""), "\n")
    
    for(i in 1:nrow(model_results)) {
        p_val <- model_results[i, "Pr(>|t|)"]
        stars <- ifelse(p_val < 0.01, "***",
                ifelse(p_val < 0.05, "**",
                ifelse(p_val < 0.1, "*",
                ifelse(p_val < 0.15, ".", ""))))
        
        cat(sprintf("%-30s %12.4f %12.4f %6s\n",
            substr(rownames(model_results)[i], 1, 60),
            model_results[i, "Estimate"],
            model_results[i, "t value"],
            stars))
    }
    cat("\nSignificance codes: 0 '***' 0.01 '**' 0.05 '*' 0.1 '.' 0.15\n")
}

# Print results
format_results(ols_robust, "OLS")

# Add model fit statistics
cat("\nModel Fit Statistics:\n")
cat("OLS R-squared:", round(summary(ols_model)$r.squared, 4), "\n")
cat("OLS Adj R-squared:", round(summary(ols_model)$adj.r.squared, 4), "\n")
```

```{r}
# Load the car package which has the vif function
library(car)

# Calculate VIFs for the model
vifs <- vif(ols_model)
vifs
```

```{r}
library(caret)

# Create the model matrix (excluding the response variable)
X <- model.matrix(~ . - attempt - 1, data = select_data)  # -1 removes intercept

# Find columns causing linear dependencies
lin_combos <- findLinearCombos(X)

# Remove problematic columns from the dataset
if (!is.null(lin_combos$remove)) {
  cols_to_remove <- colnames(X)[lin_combos$remove]
  select_data <- select_data[, (cols_to_remove) := NULL, with = FALSE]
}
```

```{r}
# now a probit model
probit_model <- glm(attempt ~  ., data = select_data, family = binomial(link = "probit"))
```

```{r}
library(sandwich)
library(lmtest)

# Get HC0-adjusted z-values and p-values for probit
robust_probit_test <- coeftest(probit_model, vcov = vcovHC(probit_model, type = "HC0"))
z_stats <- robust_probit_test[, "z value"]
p_values <- robust_probit_test[, "Pr(>|z|)"]

# Reuse the same formatting function and printing code
get_stars <- function(p) {
    if (p <= 0.01) return("***")
    if (p <= 0.05) return("**")
    if (p <= 0.1) return("*")
    if (p <= 0.15) return(".")
    return("")
}

name_width <- 60

# Print header (note "z-value" instead of "t-value")
cat(sprintf("\n\n%-*s  %10s  %10s  %4s\n", name_width, "Probit Variable", "z-value", "p-value", "sig"))
cat(sprintf("%-*s  %10s  %10s  %4s\n", name_width, "---------------", "-------", "-------", "----"))

for (i in 1:length(z_stats)) {
    var_name <- rownames(robust_probit_test)[i]
    if (nchar(var_name) > name_width) {
        var_name <- paste0(substr(var_name, 1, name_width-3), "...")
    }
    cat(sprintf("%-*s  %10.4f  %10.4f  %4s\n", 
                name_width, var_name, 
                z_stats[i], p_values[i],
                get_stars(p_values[i])))
}

cat("\nSignificance codes: 0 '***' 0.01 '**' 0.05 '*' 0.1 '.' 0.15")
```


